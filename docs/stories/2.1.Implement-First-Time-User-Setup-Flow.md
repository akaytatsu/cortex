# Story 2.1: Implement First-Time User Setup Flow

## Status

Approved

## Story

**As a** new administrator,
**I want** to be prompted to create the first user account when I access a fresh installation,
**so that** I can secure the application.

## Acceptance Criteria

1. Ao acessar a aplicação, o sistema verifica se há usuários no banco.
2. Se não houver, redireciona para uma página `/setup`.
3. A página `/setup` contém um formulário para criar o primeiro usuário.
4. Submeter o formulário cria o usuário, faz o hash da senha e cria uma sessão.
5. O usuário é redirecionado para a IDE.
6. Tentar acessar `/setup` quando já existe um usuário redireciona para `/login`.

## Tasks / Subtasks

- [ ] Task 1 (AC: 1, 2)
  - [ ] Criar service `authService` para verificar se existem usuários no banco de dados
  - [ ] Implementar loader na rota raiz (`/`) que verifica users existentes
  - [ ] Implementar lógica de redirecionamento: se sem usuários -> `/setup`, se com usuários -> `/login`
  - [ ] Configurar rota `/setup` no Remix
- [ ] Task 2 (AC: 3)
  - [ ] Criar componente React `SetupForm` usando shadcn/ui
  - [ ] Implementar formulário com campos de email e senha
  - [ ] Adicionar validação client-side com TypeScript
  - [ ] Implementar página `/setup` que renderiza o formulário
- [ ] Task 3 (AC: 4)
  - [ ] Implementar action na rota `/setup` para processar submissão do formulário
  - [ ] Adicionar hash da senha usando bcrypt ou similar
  - [ ] Integrar com Prisma para criar usuário no banco SQLite
  - [ ] Implementar criação de sessão usando Remix sessions
- [ ] Task 4 (AC: 5)
  - [ ] Implementar redirecionamento para `/workspaces` após criação bem-sucedida
  - [ ] Criar placeholder para página de workspaces (apenas para demonstrar redirecionamento)
- [ ] Task 5 (AC: 6)
  - [ ] Implementar loader na rota `/setup` que verifica se já existe usuário
  - [ ] Redirecionar para `/login` se usuário já existir
  - [ ] Criar placeholder para página `/login` (apenas para demonstrar redirecionamento)
- [ ] Task 6: Testing
  - [ ] Criar testes unitários para `authService` usando Vitest
  - [ ] Testar verificação de usuários existentes
  - [ ] Testar criação de usuário e hash de senha
  - [ ] Criar testes de integração para loaders e actions das rotas

## Dev Notes

### Previous Story Insights

- Prisma configurado com SQLite e modelo User criado [Source: Previous Story 1.3]
- Módulo de configuração central existente em `apps/web/app/lib/config.ts` [Source: Previous Story 1.4]
- Monorepo estrutura com npm workspaces [Source: Previous Story 1.1]
- ESLint e Prettier configurados [Source: Previous Story 1.2]

### Data Models

- **User Model**: Interface definida como `{ id: string; email: string; createdAt: Date; updatedAt: Date }` [Source: architecture/data-models-revised.md]
- **Database Schema**: User model no Prisma com campos `id`, `email`, `password`, `createdAt`, `updatedAt` [Source: architecture/database-schema.md]
- **Shared Types**: Definir interfaces em `packages/shared-types` conforme padrão estabelecido [Source: architecture/coding-standards.md]

### API Specifications

- **Authentication Actions**: action para `/setup`, `/login`, `/logout` conforme definido [Source: architecture/api-specification.md]
- **Loaders e Actions**: Usar padrão Remix para `loader`(leitura) e `action`(escrita) [Source: architecture/api-specification.md]

### Component Specifications

- **UI Components**: Usar shadcn/ui para componentes acessíveis e customizáveis [Source: architecture/tech-stack.md]
- **Styling**: Tailwind CSS 4.1.11 para estilização [Source: architecture/tech-stack.md]
- **Icons**: Lucide Icons para ícones [Source: architecture/tech-stack.md]

### File Locations

- **Services**: Lógica de negócio em `apps/web/app/services/` [Source: architecture/coding-standards.md]
- **Components**: Componentes React em `apps/web/app/components/` [Source: architecture/source-tree.md]
- **Routes**: Rotas, Loaders, Actions em `apps/web/app/routes/` [Source: architecture/source-tree.md]
- **Shared Types**: Interfaces TypeScript em `packages/shared-types/` [Source: architecture/source-tree.md]
- **Prisma Client**: Cliente configurado em `apps/web/app/lib/prisma.ts` [Source: Previous Story 1.3]

### Testing Requirements

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para testes isolados de services, componentes e funções utilitárias [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para testar fluxo completo de Remix routes (loader/action -> service -> test database) [Source: architecture/test-strategy.md]
- **Coverage**: Apontar para >80% de cobertura na lógica de negócio crítica [Source: architecture/test-strategy.md]

### Technical Constraints

- **Language/Runtime**: TypeScript 5.8, Node.js 22.x [Source: architecture/coding-standards.md]
- **Framework**: Remix 2.16.8 para UI e lógica de servidor [Source: architecture/tech-stack.md]
- **Database**: SQLite ~5.x com Prisma 6.x [Source: architecture/tech-stack.md]
- **Environment Variables**: Acesso apenas através de módulo de config central tipado [Source: architecture/coding-standards.md]
- **Service Layer**: Toda lógica de negócio backend deve estar em `apps/web/app/services/` [Source: architecture/coding-standards.md]
- **Error Handling**: Usar classes de erro customizadas ao lançar exceções em services [Source: architecture/coding-standards.md]

### Project Structure Notes

A estrutura do projeto alinha com os requisitos da história:
- Routes serão criadas em `apps/web/app/routes/` conforme source-tree.md
- AuthService será criado em `apps/web/app/services/` conforme coding-standards.md
- Componentes de UI em `apps/web/app/components/` conforme source-tree.md
- Interfaces compartilhadas em `packages/shared-types/` conforme coding-standards.md

### Testing

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para testes isolados de services, componentes e funções utilitárias [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para testar fluxo completo de Remix routes (loader/action -> service -> test database) [Source: architecture/test-strategy.md]
- **Coverage**: Apontar para >80% de cobertura na lógica de negócio crítica [Source: architecture/test-strategy.md]
- **Test Data Management**: Usar Prisma seed script para popular test database, garantindo testes consistentes [Source: architecture/test-strategy.md]

## Change Log

| Date       | Version | Description   | Author             |
| ---------- | ------- | ------------- | ------------------ |
| 2025-07-22 | 1.0     | Initial draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_Pendente - será preenchido pelo agente de desenvolvimento_

### Debug Log References

_Pendente - será preenchido pelo agente de desenvolvimento_

### Completion Notes List

_Pendente - será preenchido pelo agente de desenvolvimento_

### File List

_Pendente - será preenchido pelo agente de desenvolvimento_

## QA Results

_Pendente - será preenchido pelo agente de QA_