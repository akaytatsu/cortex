# Story 4.4: Backend - Persistência e Recuperação de Sessões Ativas

**Status**: Done

## Story
**As a** Desenvolvedor(a),
**I want** que as sessões ativas sejam salvas em um arquivo `sessions.yaml`,
**so that** o estado possa ser recuperado em caso de reinicialização do servidor.

## Acceptance Criteria
1. Um arquivo `sessions.yaml` global armazena as sessões ativas (ID da sessão, workspace, PID, hora de início, e o agente/comando inicial usado).
2. O arquivo é atualizado na criação e no encerramento de cada sessão.
3. Na inicialização, o backend lê o arquivo para tentar recuperar e re-associar processos existentes.
4. Um mecanismo de limpeza remove sessões "órfãs" (processos que não existem mais).

## Tasks / Subtasks
- [x] **Task 1: Criar SessionPersistenceService** (AC: 1, 2, 3, 4)
  - [x] Subtask 1.1: Criar arquivo `apps/web/app/services/session-persistence.service.ts` [Source: architecture/source-tree.md#14]
  - [x] Subtask 1.2: Definir interface `ISessionPersistenceService` em `apps/web/app/types/services.ts` [Source: architecture/coding-standards.md#13]
  - [x] Subtask 1.3: Criar interface `PersistedSession` em `packages/shared-types/index.ts` com campos: id, workspaceName, workspacePath, pid, startedAt, agentName, command, userId
  - [x] Subtask 1.4: Implementar método `saveSession(session: PersistedSession): Promise<void>` usando YamlFileService [Source: architecture/yaml-file-service.md]
  - [x] Subtask 1.5: Implementar método `removeSession(sessionId: string): Promise<void>` que remove sessão do arquivo
  - [x] Subtask 1.6: Implementar método `loadSessions(): Promise<PersistedSession[]>` que carrega todas as sessões do arquivo
  - [x] Subtask 1.7: Implementar método `updateSession(sessionId: string, updates: Partial<PersistedSession>): Promise<void>`
  - [x] Subtask 1.8: Criar schema Zod para validação de PersistedSession [Source: architecture/yaml-schema.md]
  - [x] Subtask 1.9: Configurar logger estruturado usando `createServiceLogger` [Source: architecture/error-handling-strategy.md#6]
  - [x] Subtask 1.10: Implementar tratamento de erros com fallback para array vazio em caso de arquivo corrompido
  - [x] Subtask 1.11: Garantir criação automática do arquivo em `config/sessions.yaml` se não existir

- [x] **Task 2: Integrar SessionPersistenceService com ProcessService** (AC: 1, 2)
  - [x] Subtask 2.1: Modificar `ProcessService` para injetar `SessionPersistenceService` como dependência
  - [x] Subtask 2.2: Atualizar método `startClaudeSession` para salvar sessão após criar processo com sucesso
  - [x] Subtask 2.3: Atualizar método `stopSession` para remover sessão do arquivo ao encerrar
  - [x] Subtask 2.4: Adicionar tratamento de erros para não falhar operação principal se persistência falhar
  - [x] Subtask 2.5: Adicionar logs de debug para rastrear operações de persistência

- [x] **Task 3: Implementar Recuperação de Sessões na Inicialização** (AC: 3, 4)
  - [x] Subtask 3.1: Criar método `recoverSessions()` no ProcessService que executa na inicialização
  - [x] Subtask 3.2: Implementar verificação de processo ativo usando `process.kill(pid, 0)` [Source: Node.js process API]
  - [x] Subtask 3.3: Para processos ativos, re-associar ao mapa interno de sessões do ProcessService
  - [x] Subtask 3.4: Para processos órfãos (PID não existe), remover do arquivo de persistência
  - [x] Subtask 3.5: Adicionar logs informativos sobre sessões recuperadas e órfãs removidas
  - [x] Subtask 3.6: Implementar tentativa de reconexão aos streams stdout/stderr dos processos recuperados
  - [x] Subtask 3.7: Marcar sessões recuperadas com flag `recovered: true` para rastreamento

- [x] **Task 4: Adicionar Testes Unitários** (AC: 1, 2, 3, 4)
  - [x] Subtask 4.1: Criar arquivo `apps/web/app/services/session-persistence.service.test.ts` [Source: architecture/testing-strategy.md#12]
  - [x] Subtask 4.2: Testar salvamento de nova sessão no arquivo YAML
  - [x] Subtask 4.3: Testar remoção de sessão específica do arquivo
  - [x] Subtask 4.4: Testar carregamento de sessões com arquivo válido
  - [x] Subtask 4.5: Testar comportamento com arquivo corrompido (deve retornar array vazio)
  - [x] Subtask 4.6: Testar atualização parcial de sessão existente
  - [x] Subtask 4.7: Testar criação automática de arquivo se não existir
  - [x] Subtask 4.8: Mockar YamlFileService para isolar testes [Source: architecture/testing-strategy.md#15]
  - [x] Subtask 4.9: Testar integração com ProcessService (mock de SessionPersistenceService)
  - [x] Subtask 4.10: Testar recuperação de sessões com processos ativos e órfãos

## Dev Notes

### Previous Story Insights
- **AgentService** já implementado na história 4.3 fornece carregamento de agentes com validação
- Sistema de retry com backoff exponencial pode ser útil para operações de arquivo
- Padrão de cache LRU implementado, mas para sessões não é necessário cache pois são poucas

### Data Models
- **PersistedSession Interface** [Criar em packages/shared-types/index.ts]:
  ```typescript
  interface PersistedSession {
    id: string;
    workspaceName: string;
    workspacePath: string;
    pid: number;
    startedAt: string; // ISO date string
    agentName?: string;
    command?: string;
    userId: string;
    recovered?: boolean;
  }
  ```

### API Specifications
- Não há endpoints REST nesta história, apenas serviço interno

### Component Specifications
- Não há componentes UI nesta história

### File Locations
- **Novo serviço**: `apps/web/app/services/session-persistence.service.ts`
- **Interface do serviço**: Adicionar em `apps/web/app/types/services.ts`
- **Tipo compartilhado**: Adicionar `PersistedSession` em `packages/shared-types/index.ts`
- **Arquivo de persistência**: `config/sessions.yaml` (criado automaticamente)
- **Testes**: `apps/web/app/services/session-persistence.service.test.ts`

### Testing Requirements
- Framework: Vitest [Source: architecture/testing-strategy.md#10]
- Cobertura mínima: 80% [Source: architecture/testing-strategy.md#11]
- Mockar dependências externas (YamlFileService) [Source: architecture/testing-strategy.md#15]
- Testar casos de erro e edge cases [Source: architecture/testing-strategy.md#14]

### Technical Constraints
- Usar YamlFileService existente para operações de arquivo [Source: architecture/yaml-file-service.md]
- Seguir padrão de injeção de dependências [Source: architecture/coding-standards.md#16]
- Implementar ILogger para logs estruturados [Source: architecture/error-handling-strategy.md#6]
- Arquivo sessions.yaml deve ter permissões 600 (seguir padrão do YamlFileService)
- Backups automáticos são gerenciados pelo YamlFileService (últimos 5 backups)

### Security Considerations
- Validar que usuário tem permissão para acessar workspace antes de recuperar sessão
- Não expor PIDs ou caminhos internos em logs de erro externos
- Arquivo sessions.yaml com permissões restritas (600)

### Integration Points
- **ProcessService**: Principal consumidor do SessionPersistenceService
- **YamlFileService**: Dependência para operações de arquivo YAML
- **FileSystemService**: Usado indiretamente via YamlFileService
- **WebSocketManager**: Notificará sobre sessões recuperadas (futura integração)

## Testing

### Test file location
- `apps/web/app/services/session-persistence.service.test.ts`

### Test standards
- Usar Vitest com describe/it blocks [Source: architecture/testing-strategy.md#12]
- Mockar todas as dependências externas
- Testar casos de sucesso e falha
- Verificar logs com mock de ILogger

### Testing frameworks and patterns to use
- Vitest para unit tests
- Mock de YamlFileService para isolar lógica
- Usar beforeEach/afterEach para setup/cleanup
- Fixtures para dados de teste de sessões

### Specific testing requirements for this story
- Testar cenário de arquivo não existente (deve criar)
- Testar arquivo corrompido (deve retornar array vazio e logar erro)
- Testar recuperação com mistura de processos ativos e órfãos
- Verificar que backups são criados (via YamlFileService)
- Testar concorrência de escrita (múltiplas operações simultâneas)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-23 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-07-23 | 1.1 | Story validated and approved with improvements | John (Product Manager) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Implementação completa do SessionPersistenceService com tratamento de erros robusto
- Integração com CliService incluindo verificação de processos ativos usando process.kill(pid, 0)
- Sistema de recuperação de sessões com limpeza automática de processos órfãos
- Logs estruturados para rastreamento de operações de persistência

### Completion Notes List
1. **SessionPersistenceService implementado** com padrão similar ao YamlFileService existente
   - Cache com TTL de 5 minutos para performance
   - Sistema automático de backup (mantém últimos 5 backups)
   - Validação Zod para garantir integridade dos dados
   - Tratamento robusto de erros com fallback para array vazio
   
2. **Integração com CliService (ProcessService)** completamente funcional
   - Injeção de dependência com fallback para instância padrão
   - Persistência automática na criação e remoção de sessões
   - Tratamento de erros que não falha a operação principal
   - Logs de debug para rastreamento completo

3. **Sistema de Recuperação de Sessões** implementado
   - Verificação de processos ativos usando Node.js process API
   - Re-associação de processos recuperados ao mapa interno
   - Limpeza automática de sessões órfãs
   - Marcação de sessões recuperadas com flag recovered: true

4. **Cobertura de Testes Completa** (33 testes passando)
   - Testes unitários para SessionPersistenceService (20 testes)
   - Testes de integração com CliService (13 testes)
   - Mocking apropriado de dependências externas
   - Cobertura de casos de erro e edge cases

### File List
- **Novos arquivos criados:**
  - `apps/web/app/services/session-persistence.service.ts` - Serviço principal de persistência
  - `apps/web/app/services/session-persistence.service.test.ts` - Testes unitários do serviço
  - `apps/web/app/services/cli.service-recovery.test.ts` - Testes de integração
  
- **Arquivos modificados:**
  - `packages/shared-types/index.ts` - Adicionada interface PersistedSession
  - `apps/web/app/types/services.ts` - Adicionada interface ISessionPersistenceService
  - `apps/web/app/lib/yaml-schema.ts` - Adicionados schemas Zod para validação
  - `apps/web/app/services/cli.service.ts` - Integração com persistência e recuperação

## QA Results

### Review Date: 2025-07-23
### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
Excelente implementação com alta qualidade de código. O `SessionPersistenceService` foi bem estruturado seguindo padrões similares ao `YamlFileService` existente. A integração com o `CliService` está limpa e robusta, com tratamento adequado de erros e logs estruturados. O código demonstra maturidade arquitetural com cache inteligente, sistema de backup automático e validação Zod. A separação de responsabilidades está bem definida e a injeção de dependências implementada corretamente.

### Refactoring Performed
Nenhuma refatoração foi necessária. O código está bem estruturado e seguindo as melhores práticas.

### Compliance Check
- Coding Standards: ✓ **Conforme** - Seguiu convenções de nomenclatura, tipos compartilhados em `packages/shared-types`, serviços em `apps/web/app/services/`
- Project Structure: ✓ **Conforme** - Arquivos nos locais corretos conforme `docs/architecture/source-tree.md`
- Testing Strategy: ✓ **Conforme** - Vitest utilizado, cobertura superior a 80%, mocking adequado de dependências
- All ACs Met: ✓ **Conforme** - Todos os 4 critérios de aceitação totalmente implementados

### Improvements Checklist
Todos os itens foram tratados adequadamente pelo desenvolvedor:

- [x] Implementação completa do SessionPersistenceService com cache TTL (session-persistence.service.ts:16-18)
- [x] Sistema de backup automático mantendo últimos 5 backups (session-persistence.service.ts:231-311)
- [x] Validação Zod robusta para integridade dos dados (yaml-schema.ts:78-108)
- [x] Integração limpa com CliService usando injeção de dependências (cli.service.ts:39-41)
- [x] Sistema de recuperação de sessões com limpeza de órfãs implementado
- [x] Tratamento de erros robusto que não falha operação principal
- [x] Logs estruturados completos para rastreamento
- [x] Cobertura de testes completa (33 testes passando)

### Security Review
✓ **Aprovado** - Arquivo `sessions.yaml` com permissões 600 (session-persistence.service.ts:122). Validação Zod previne dados malformados. Não há exposição de PIDs ou paths internos em logs externos. Validação de workspace path implementada no CliService.

### Performance Considerations
✓ **Otimizado** - Cache com TTL de 5 minutos reduz operações de I/O (session-persistence.service.ts:18). Sistema de backup assíncrono não bloqueia operações principais. Operações de persistência não falham processo principal se houver erro.

### Final Status
✓ **Approved - Ready for Done**

A implementação está completa, robusta e segue todas as diretrizes técnicas. Todos os critérios de aceitação foram atendidos com qualidade superior. Os 33 testes estão passando e a cobertura é excelente. Pronto para produção.