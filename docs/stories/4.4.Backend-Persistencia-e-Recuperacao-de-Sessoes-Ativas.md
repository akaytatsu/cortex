# Story 4.4: Backend - Persistência e Recuperação de Sessões Ativas

**Status**: Approved

## Story
**As a** Desenvolvedor(a),
**I want** que as sessões ativas sejam salvas em um arquivo `sessions.yaml`,
**so that** o estado possa ser recuperado em caso de reinicialização do servidor.

## Acceptance Criteria
1. Um arquivo `sessions.yaml` global armazena as sessões ativas (ID da sessão, workspace, PID, hora de início, e o agente/comando inicial usado).
2. O arquivo é atualizado na criação e no encerramento de cada sessão.
3. Na inicialização, o backend lê o arquivo para tentar recuperar e re-associar processos existentes.
4. Um mecanismo de limpeza remove sessões "órfãs" (processos que não existem mais).

## Tasks / Subtasks
- [ ] **Task 1: Criar SessionPersistenceService** (AC: 1, 2, 3, 4)
  - [ ] Subtask 1.1: Criar arquivo `apps/web/app/services/session-persistence.service.ts` [Source: architecture/source-tree.md#14]
  - [ ] Subtask 1.2: Definir interface `ISessionPersistenceService` em `apps/web/app/types/services.ts` [Source: architecture/coding-standards.md#13]
  - [ ] Subtask 1.3: Criar interface `PersistedSession` em `packages/shared-types/index.ts` com campos: id, workspaceName, workspacePath, pid, startedAt, agentName, command, userId
  - [ ] Subtask 1.4: Implementar método `saveSession(session: PersistedSession): Promise<void>` usando YamlFileService [Source: architecture/yaml-file-service.md]
  - [ ] Subtask 1.5: Implementar método `removeSession(sessionId: string): Promise<void>` que remove sessão do arquivo
  - [ ] Subtask 1.6: Implementar método `loadSessions(): Promise<PersistedSession[]>` que carrega todas as sessões do arquivo
  - [ ] Subtask 1.7: Implementar método `updateSession(sessionId: string, updates: Partial<PersistedSession>): Promise<void>`
  - [ ] Subtask 1.8: Criar schema Zod para validação de PersistedSession [Source: architecture/yaml-schema.md]
  - [ ] Subtask 1.9: Configurar logger estruturado usando `createServiceLogger` [Source: architecture/error-handling-strategy.md#6]
  - [ ] Subtask 1.10: Implementar tratamento de erros com fallback para array vazio em caso de arquivo corrompido
  - [ ] Subtask 1.11: Garantir criação automática do arquivo em `config/sessions.yaml` se não existir

- [ ] **Task 2: Integrar SessionPersistenceService com ProcessService** (AC: 1, 2)
  - [ ] Subtask 2.1: Modificar `ProcessService` para injetar `SessionPersistenceService` como dependência
  - [ ] Subtask 2.2: Atualizar método `startClaudeSession` para salvar sessão após criar processo com sucesso
  - [ ] Subtask 2.3: Atualizar método `stopSession` para remover sessão do arquivo ao encerrar
  - [ ] Subtask 2.4: Adicionar tratamento de erros para não falhar operação principal se persistência falhar
  - [ ] Subtask 2.5: Adicionar logs de debug para rastrear operações de persistência

- [ ] **Task 3: Implementar Recuperação de Sessões na Inicialização** (AC: 3, 4)
  - [ ] Subtask 3.1: Criar método `recoverSessions()` no ProcessService que executa na inicialização
  - [ ] Subtask 3.2: Implementar verificação de processo ativo usando `process.kill(pid, 0)` [Source: Node.js process API]
  - [ ] Subtask 3.3: Para processos ativos, re-associar ao mapa interno de sessões do ProcessService
  - [ ] Subtask 3.4: Para processos órfãos (PID não existe), remover do arquivo de persistência
  - [ ] Subtask 3.5: Adicionar logs informativos sobre sessões recuperadas e órfãs removidas
  - [ ] Subtask 3.6: Implementar tentativa de reconexão aos streams stdout/stderr dos processos recuperados
  - [ ] Subtask 3.7: Marcar sessões recuperadas com flag `recovered: true` para rastreamento

- [ ] **Task 4: Adicionar Testes Unitários** (AC: 1, 2, 3, 4)
  - [ ] Subtask 4.1: Criar arquivo `apps/web/app/services/session-persistence.service.test.ts` [Source: architecture/testing-strategy.md#12]
  - [ ] Subtask 4.2: Testar salvamento de nova sessão no arquivo YAML
  - [ ] Subtask 4.3: Testar remoção de sessão específica do arquivo
  - [ ] Subtask 4.4: Testar carregamento de sessões com arquivo válido
  - [ ] Subtask 4.5: Testar comportamento com arquivo corrompido (deve retornar array vazio)
  - [ ] Subtask 4.6: Testar atualização parcial de sessão existente
  - [ ] Subtask 4.7: Testar criação automática de arquivo se não existir
  - [ ] Subtask 4.8: Mockar YamlFileService para isolar testes [Source: architecture/testing-strategy.md#15]
  - [ ] Subtask 4.9: Testar integração com ProcessService (mock de SessionPersistenceService)
  - [ ] Subtask 4.10: Testar recuperação de sessões com processos ativos e órfãos

## Dev Notes

### Previous Story Insights
- **AgentService** já implementado na história 4.3 fornece carregamento de agentes com validação
- Sistema de retry com backoff exponencial pode ser útil para operações de arquivo
- Padrão de cache LRU implementado, mas para sessões não é necessário cache pois são poucas

### Data Models
- **PersistedSession Interface** [Criar em packages/shared-types/index.ts]:
  ```typescript
  interface PersistedSession {
    id: string;
    workspaceName: string;
    workspacePath: string;
    pid: number;
    startedAt: string; // ISO date string
    agentName?: string;
    command?: string;
    userId: string;
    recovered?: boolean;
  }
  ```

### API Specifications
- Não há endpoints REST nesta história, apenas serviço interno

### Component Specifications
- Não há componentes UI nesta história

### File Locations
- **Novo serviço**: `apps/web/app/services/session-persistence.service.ts`
- **Interface do serviço**: Adicionar em `apps/web/app/types/services.ts`
- **Tipo compartilhado**: Adicionar `PersistedSession` em `packages/shared-types/index.ts`
- **Arquivo de persistência**: `config/sessions.yaml` (criado automaticamente)
- **Testes**: `apps/web/app/services/session-persistence.service.test.ts`

### Testing Requirements
- Framework: Vitest [Source: architecture/testing-strategy.md#10]
- Cobertura mínima: 80% [Source: architecture/testing-strategy.md#11]
- Mockar dependências externas (YamlFileService) [Source: architecture/testing-strategy.md#15]
- Testar casos de erro e edge cases [Source: architecture/testing-strategy.md#14]

### Technical Constraints
- Usar YamlFileService existente para operações de arquivo [Source: architecture/yaml-file-service.md]
- Seguir padrão de injeção de dependências [Source: architecture/coding-standards.md#16]
- Implementar ILogger para logs estruturados [Source: architecture/error-handling-strategy.md#6]
- Arquivo sessions.yaml deve ter permissões 600 (seguir padrão do YamlFileService)
- Backups automáticos são gerenciados pelo YamlFileService (últimos 5 backups)

### Security Considerations
- Validar que usuário tem permissão para acessar workspace antes de recuperar sessão
- Não expor PIDs ou caminhos internos em logs de erro externos
- Arquivo sessions.yaml com permissões restritas (600)

### Integration Points
- **ProcessService**: Principal consumidor do SessionPersistenceService
- **YamlFileService**: Dependência para operações de arquivo YAML
- **FileSystemService**: Usado indiretamente via YamlFileService
- **WebSocketManager**: Notificará sobre sessões recuperadas (futura integração)

## Testing

### Test file location
- `apps/web/app/services/session-persistence.service.test.ts`

### Test standards
- Usar Vitest com describe/it blocks [Source: architecture/testing-strategy.md#12]
- Mockar todas as dependências externas
- Testar casos de sucesso e falha
- Verificar logs com mock de ILogger

### Testing frameworks and patterns to use
- Vitest para unit tests
- Mock de YamlFileService para isolar lógica
- Usar beforeEach/afterEach para setup/cleanup
- Fixtures para dados de teste de sessões

### Specific testing requirements for this story
- Testar cenário de arquivo não existente (deve criar)
- Testar arquivo corrompido (deve retornar array vazio e logar erro)
- Testar recuperação com mistura de processos ativos e órfãos
- Verificar que backups são criados (via YamlFileService)
- Testar concorrência de escrita (múltiplas operações simultâneas)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-23 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-07-23 | 1.1 | Story validated and approved with improvements | John (Product Manager) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]