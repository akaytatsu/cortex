# Story 3.5: Enable Real-time Code Editing and Saving

## Status

Approved

## Story

**As a** logged-in user,
**I want** to edit and save files,
**so that** I can modify my code.

## Acceptance Criteria

1. O editor permite edição.
2. Salvar envia o conteúdo para o backend.
3. O backend atualiza o arquivo correto no caminho do workspace.

## Tasks / Subtasks

- [ ] Task 1 (AC: 1): Enable code editing functionality in CodeViewer
  - [ ] Convert CodeViewer from read-only to editable mode
  - [ ] Implement text editing capabilities with syntax highlighting preservation
  - [ ] Add save indicators (dirty state, unsaved changes indicator)
  - [ ] Implement keyboard shortcuts for save (Ctrl+S)
  - [ ] Handle large file editing with performance optimizations
- [ ] Task 2 (AC: 2): Create file save API endpoint and mechanism
  - [ ] Create API action in `/api/workspaces/$workspaceName/file/save`
  - [ ] Implement file save functionality in FileSystemService
  - [ ] Add validation for file write permissions and path security
  - [ ] Implement optimistic updates for better UX
  - [ ] Handle concurrent edit conflict detection
- [ ] Task 3 (AC: 3): Integrate save mechanism with workspace file system
  - [ ] Ensure saves respect workspace path boundaries (security)
  - [ ] Implement atomic file writes to prevent corruption
  - [ ] Add backup/temp file mechanism for safe writes
  - [ ] Create file change notifications/watchers if needed
- [ ] Task 4: Testing
  - [ ] Unit tests for enhanced FileSystemService save methods
  - [ ] Integration tests for file editing → save → verify changes workflow
  - [ ] Test security boundaries and path validation
  - [ ] Test concurrent editing scenarios and conflict resolution
  - [ ] Test large file editing and performance

## Dev Notes

### Previous Story Insights

- **CodeViewer Established**: Component já implementado em read-only mode em `apps/web/app/components/CodeViewer.tsx` com syntax highlighting usando Prism.js [Source: Previous Story 3.4]
- **FileSystemService Exists**: Service já implementado com security validation para file reading em `apps/web/app/services/filesystem.service.ts` [Source: Previous Story 3.4]
- **API Endpoints Pattern**: Pattern estabelecido para endpoints de workspace em `apps/web/app/routes/api.workspaces.$workspaceName.file.tsx` [Source: Previous Story 3.4]
- **Security Validation**: Robust path validation already implemented para prevenir directory traversal attacks [Source: Previous Story 3.4]
- **Shared State**: Communication pattern entre components via Remix state management já estabelecido [Source: Previous Story 3.4]

### Data Models

- **FileContent Interface**: Já definida em `packages/shared-types/index.ts` com `path`, `content`, `mimeType` [Source: architecture/data-models-revised.md]
- **New Interface Needed**:
  ```typescript
  interface FileSaveRequest {
    path: string;
    content: string;
    lastModified?: Date; // for conflict detection
  }

  interface FileSaveResponse {
    success: boolean;
    message?: string;
    newLastModified?: Date;
  }
  ```
- **Workspace Model**: Interface `{ name: string; path: string }` mantém-se inalterada [Source: architecture/data-models-revised.md]

### API Specifications

- **File Save Endpoint**: Novo endpoint `POST /api/workspaces/$workspaceName/file/save` deve ser criado [Source: architecture/api-specification.md]
- **Security**: Todas as operações devem manter proteção via `SessionService.requireUserId()` [Source: Previous Stories]
- **Path Validation**: Reutilizar validação rigorosa existente do FileSystemService para prevenir write access fora do workspace [Source: Previous Story 3.4]
- **Error Handling**: Implementar tratamento para scenarios: arquivo não encontrado, sem permissão de escrita, disco cheio, etc. [Source: architecture/api-specification.md]
- **Request Format**: JSON payload com path e content, response JSON com status e message [Source: architecture/api-specification.md]

### Component Specifications

- **CodeViewer Enhancement**: Modificar componente existente `apps/web/app/components/CodeViewer.tsx` para mode editable [Source: architecture/source-tree.md]
- **Editor Library**: Continue using Prism.js para syntax highlighting mas adicionar editing capabilities ou considerar upgrade para Monaco Editor ou similar [Source: architecture/tech-stack.md]
- **UI Components**: Usar Tailwind CSS e shadcn/ui components para save buttons, status indicators, etc. [Source: architecture/tech-stack.md]
- **Icons**: Usar Lucide Icons para save, dirty state, loading indicators [Source: architecture/tech-stack.md]
- **State Management**: Use Remix's built-in state management para track dirty state e trigger saves [Source: architecture/tech-stack.md]

### File Locations

- **Modified Service**: Extend `apps/web/app/services/filesystem.service.ts` com save functionality [Source: architecture/coding-standards.md, architecture/system-components.md]
- **Modified Component**: Enhance `apps/web/app/components/CodeViewer.tsx` existente para add editing capability [Source: architecture/source-tree.md]
- **New API Route**: Criar `apps/web/app/routes/api.workspaces.$workspaceName.file.save.tsx` para save endpoint [Source: architecture/source-tree.md]
- **Updated Types**: Add new interfaces em `packages/shared-types/index.ts` para save requests/responses [Source: architecture/coding-standards.md]
- **IDELayout Integration**: Minor updates em `apps/web/app/components/IDELayout.tsx` se needed para handle save state [Source: Previous Story 3.3]

### Testing Requirements

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para FileSystemService save methods e enhanced CodeViewer component [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para complete flow: edit → save → verify file changes [Source: architecture/test-strategy.md]
- **Coverage**: Manter >80% de cobertura na lógica crítica de file saving [Source: architecture/test-strategy.md]
- **Security Testing**: Testar tentativas de escrita fora do workspace autorizado, path traversal attacks [Source: Previous Story 3.4 patterns]
- **Concurrency Testing**: Test concurrent editing scenarios e conflict resolution [Source: Best Practices]
- **Performance Testing**: Test editing e saving de arquivos grandes [Source: Best Practices]

### Technical Constraints

- **Language/Runtime**: Manter TypeScript 5.8, Node.js 22.x [Source: architecture/coding-standards.md]
- **Framework**: Continuar Remix 2.16.8 para rotas e actions [Source: architecture/tech-stack.md]
- **Service Layer**: FileSystemService deve seguir padrão estabelecido em `apps/web/app/services/` [Source: architecture/coding-standards.md]
- **File System Access**: Todas interações com file system devem passar pelo FileSystemService [Source: architecture/coding-standards.md]
- **Error Handling**: Usar custom error classes para diferentes tipos de file system errors [Source: architecture/coding-standards.md]
- **Atomic Operations**: Implement atomic file writes to prevent corruption during saves [Source: Best Practices]
- **Security**: Manter validação rigorosa de paths para prevenir unauthorized file access [Source: Previous Story 3.4]

### Project Structure Notes

A estrutura do projeto está bem alinhada com os requirements da story:
- FileSystemService existente pode ser extended com save functionality
- CodeViewer component existente pode be enhanced to support editing
- API route pattern já estabelecido pode be followed para new save endpoint
- Shared types pattern maintained para consistency
- Existing security patterns podem be reused para write operations

### Testing

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para FileSystemService save methods e enhanced CodeViewer [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para edit → save → verification workflow [Source: architecture/test-strategy.md]
- **Security Tests**: Para write path validation e prevention of directory traversal [Source: Previous Stories patterns]
- **Performance Tests**: Para large file editing e saving operations [Source: Best Practices]
- **Concurrency Tests**: Para concurrent editing scenarios [Source: Best Practices]

## Change Log

| Date       | Version | Description   | Author             |
| ---------- | ------- | ------------- | ------------------ |
| 2025-07-22 | 1.0     | Initial draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)