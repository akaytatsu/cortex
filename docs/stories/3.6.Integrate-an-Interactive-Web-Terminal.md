# Story 3.6: Integrate an Interactive Web Terminal

## Status

Approved

## Story

**As a** logged-in user,
**I want** an interactive terminal scoped to my workspace,
**so that** I can run commands.

## Acceptance Criteria

1. O painel inferior contém um terminal web funcional.
2. A sessão do terminal inicia no diretório do workspace selecionado.

## Tasks / Subtasks

- [ ] Task 1 (AC: 1): Implement web terminal component with interactive functionality
  - [ ] Research and select appropriate web terminal library (e.g. xterm.js)
  - [ ] Create Terminal component with basic UI integration
  - [ ] Integrate terminal component into IDELayout bottom panel
  - [ ] Implement terminal display with proper styling (dark theme consistent with IDE)
  - [ ] Add terminal resizing capabilities within the panel
- [ ] Task 2 (AC: 1, 2): Create WebSocket-based terminal backend
  - [ ] Set up WebSocket server integration with Remix
  - [ ] Create TerminalService for managing terminal sessions
  - [ ] Implement spawn terminal process scoped to workspace directory
  - [ ] Handle terminal input/output streaming via WebSocket
  - [ ] Implement proper process cleanup on session end
- [ ] Task 3 (AC: 2): Implement workspace directory scoping
  - [ ] Ensure terminal sessions start in correct workspace path
  - [ ] Validate workspace path security (prevent escaping workspace bounds)
  - [ ] Handle workspace switching (terminate/restart terminal sessions)
  - [ ] Implement environment variable inheritance from workspace context
- [ ] Task 4: Testing and error handling
  - [ ] Unit tests for TerminalService functionality
  - [ ] Integration tests for WebSocket terminal communication
  - [ ] Test terminal process lifecycle management
  - [ ] Test security boundaries and workspace path validation
  - [ ] Test concurrent terminal sessions handling
  - [ ] Handle terminal process errors and connection failures

## Dev Notes

### Previous Story Insights

- **IDELayout Structure**: Main layout component já implementado em `apps/web/app/components/IDELayout.tsx` com painéis redimensionáveis e bottom panel preparado [Source: Previous Story 3.3]
- **Workspace Management**: Pattern estabelecido para workspace selection e navigation em `apps/web/app/routes/workspaces.$workspaceName.tsx` [Source: Previous Story 3.3]
- **FileSystemService Security**: Robust path validation já implementado para prevenir directory traversal attacks - mesmo pattern deve ser usado para terminal sessions [Source: Previous Story 3.4, 3.5]
- **WebSocket Foundation**: Real-time communication via WebSockets já mencionado na API specification para funcionalidades interativas como Terminal [Source: architecture/api-specification.md]
- **Session Management**: SessionService pattern estabelecido para user authentication - deve ser usado para terminal session security [Source: Previous Stories]

### Data Models

- **Terminal Session Interface**: Novo modelo necessário para gerenciar sessões de terminal
  ```typescript
  interface TerminalSession {
    id: string;
    workspaceName: string;
    workspacePath: string;
    userId: string;
    pid?: number; // process ID of terminal
    status: 'active' | 'inactive' | 'terminated';
    createdAt: Date;
  }

  interface TerminalMessage {
    type: 'input' | 'output' | 'error' | 'exit';
    data: string;
    sessionId: string;
  }
  ```
- **Workspace Model**: Interface existente `{ name: string; path: string }` será reutilizada para determinar working directory [Source: architecture/data-models-revised.md]

### API Specifications

- **WebSocket Terminal Endpoint**: Novo WebSocket endpoint `/ws/terminal` para comunicação real-time [Source: architecture/api-specification.md]
- **Security**: Todas as sessões de terminal devem validar autenticação via `SessionService.requireUserId()` [Source: Previous Stories]
- **Terminal Spawn API**: Novo endpoint para criar/gerenciar sessões de terminal [Source: architecture/api-specification.md]
- **Message Protocol**: Protocolo WebSocket para input/output streaming com types específicos (input, output, error, exit)

### Component Specifications

- **Terminal Component**: Novo componente `apps/web/app/components/Terminal.tsx` usando biblioteca web terminal (xterm.js recomendado) [Source: architecture/source-tree.md]
- **IDELayout Integration**: Modificar `apps/web/app/components/IDELayout.tsx` para incluir Terminal component no bottom panel [Source: architecture/source-tree.md]
- **UI Components**: Usar Tailwind CSS e shadcn/ui components para terminal controls, status indicators [Source: architecture/tech-stack.md]
- **Icons**: Usar Lucide Icons para terminal, close, expand/collapse indicators [Source: architecture/tech-stack.md]
- **Styling**: Terminal deve usar dark theme consistente com o rest of IDE, monospace font for code readability

### File Locations

- **New Component**: Criar `apps/web/app/components/Terminal.tsx` para web terminal interface [Source: architecture/source-tree.md]
- **New Service**: Criar `apps/web/app/services/terminal.service.ts` para terminal session management [Source: architecture/coding-standards.md]
- **WebSocket Integration**: Modificar ou criar WebSocket handler em `apps/web/app/lib/` para terminal communication [Source: architecture/source-tree.md]
- **Modified Layout**: Atualizar `apps/web/app/components/IDELayout.tsx` para include terminal panel [Source: Previous Story 3.3]
- **Route Integration**: Integrar terminal functionality na workspace route `apps/web/app/routes/workspaces.$workspaceName.tsx` [Source: Previous Stories]
- **Updated Types**: Adicionar terminal-related interfaces em `packages/shared-types/index.ts` [Source: architecture/coding-standards.md]

### Testing Requirements

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para TerminalService methods e Terminal component [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para WebSocket communication e terminal process lifecycle [Source: architecture/test-strategy.md]
- **Coverage**: Manter >80% de cobertura na lógica crítica de terminal management [Source: architecture/test-strategy.md]
- **Security Testing**: Testar workspace path validation, process isolation, prevent command injection [Source: Previous Story patterns]
- **Process Testing**: Test terminal process spawning, cleanup, zombie process prevention
- **WebSocket Testing**: Test connection handling, message streaming, reconnection scenarios

### Technical Constraints

- **Language/Runtime**: Manter TypeScript 5.8, Node.js 22.x [Source: architecture/coding-standards.md]
- **Framework**: Continuar Remix 2.16.8 para rotas e WebSocket integration [Source: architecture/tech-stack.md]
- **Service Layer**: TerminalService deve seguir padrão estabelecido em `apps/web/app/services/` [Source: architecture/coding-standards.md]
- **WebSocket Library**: Implementar WebSocket support using Node.js built-in or compatible library
- **Terminal Library**: Use xterm.js or similar web terminal library for frontend terminal emulation
- **Process Management**: Use Node.js child_process module for terminal process spawning
- **Security**: Todas as sessões de terminal devem validar workspace path boundaries [Source: Previous Story security patterns]
- **Error Handling**: Usar custom error classes para diferentes tipos de terminal errors [Source: architecture/coding-standards.md]
- **Process Isolation**: Garantir que processos de terminal não possam escapar do workspace directory
- **CRITICAL RULE - Remix Fetcher**: NUNCA adicionar `fetcher` ou `fetcher.load` em dependências do useEffect - causa loops infinitos [Source: Previous Story 3.5 critical fix]

### Project Structure Notes

A estrutura do projeto está preparada para integração de terminal:
- IDELayout component já tem bottom panel preparado para terminal
- WebSocket support já mencionado na API specification para real-time features
- Service layer pattern já estabelecido pode ser seguido para TerminalService
- Security patterns existentes podem ser reutilizados para terminal session validation
- Shared types pattern maintained para terminal-related interfaces

### Testing

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para TerminalService methods e Terminal component [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para WebSocket terminal communication flow [Source: architecture/test-strategy.md]
- **Security Tests**: Para workspace path validation e process isolation [Source: Previous Stories patterns]
- **Process Tests**: Para terminal process lifecycle, cleanup, zombie prevention
- **WebSocket Tests**: Para connection handling, message streaming, error scenarios

## Change Log

| Date       | Version | Description   | Author             |
| ---------- | ------- | ------------- | ------------------ |
| 2025-07-22 | 1.0     | Initial draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results