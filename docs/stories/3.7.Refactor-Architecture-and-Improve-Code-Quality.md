# Story 3.7: Refactor-Architecture-and-Improve-Code-Quality

## Status
Approved

## Story
**As a** desenvolvedor trabalhando nos serviços backend do Cortex,
**I want** uma arquitetura de serviços padronizada e manutenível,
**so that** eu possa desenvolver e debugar funcionalidades backend com mais eficiência

## Acceptance Criteria

1. **Padronização da Camada de Serviços**
   - Criar interfaces para todos os serviços (IAuthService, IUserService, etc.)
   - Implementar padrão de injeção de dependência com container de serviços
   - Padronizar padrões de instanciação de serviços (remover mistura de static/instance/singleton)
   - Todos os serviços devem implementar suas interfaces correspondentes

2. **Gerenciamento de Configuração**
   - Criar módulo de configuração centralizado (`app/lib/config.ts`)
   - Mover todos os números mágicos para constantes de configuração
   - Configuração baseada em ambiente com segurança de tipos
   - Validação de configuração na inicialização

3. **Logging Estruturado**
   - Implementar logging estruturado com formato consistente
   - Substituir todos os `console.log/error` com logger estruturado
   - Adicionar IDs de correlação para rastreamento de requisições
   - Configurar diferentes níveis de log para desenvolvimento/produção

4. **Aprimoramento do Tratamento de Erros Backend**
   - Padronizar formato de resposta de erro em todos os serviços
   - Criar sistema de classificação de erros (ValidationError, AuthError, etc.)
   - Adicionar mecanismos de recuperação de erro quando apropriado
   - Implementar logging de erro adequado com contexto

## Tasks / Subtasks

- [ ] **Phase 1: Create Foundation Infrastructure** (AC: 1, 2, 3)
  - [ ] Create service interfaces in `app/types/services.ts`
    - [ ] Define IAuthService interface
    - [ ] Define IUserService interface
    - [ ] Define ITerminalService interface
    - [ ] Define IFileSystemService interface
    - [ ] Define IWorkspaceService interface
  - [ ] Implement centralized configuration in `app/lib/config.ts`
    - [ ] Create typed configuration structure
    - [ ] Add environment-based configuration loading
    - [ ] Add configuration validation on startup
    - [ ] Move all magic numbers to configuration constants
  - [ ] Set up structured logging in `app/lib/logger.ts`
    - [ ] Create ILogger interface with context support
    - [ ] Implement structured logger with correlation IDs
    - [ ] Configure different log levels for dev/prod
    - [ ] Add log formatting for consistent output

- [ ] **Phase 2: Refactor Services to Use Interfaces** (AC: 1, 4)
  - [ ] Refactor AuthService to implement IAuthService
    - [ ] Update method signatures to match interface
    - [ ] Integrate with centralized config and logger
    - [ ] Standardize error handling and responses
  - [ ] Refactor UserService to implement IUserService
    - [ ] Update method signatures to match interface
    - [ ] Integrate with centralized config and logger
    - [ ] Standardize error handling and responses
  - [ ] Refactor TerminalService to implement ITerminalService
    - [ ] Update method signatures to match interface
    - [ ] Integrate with centralized config and logger
    - [ ] Standardize error handling and responses
  - [ ] Refactor FileSystemService to implement IFileSystemService
    - [ ] Update method signatures to match interface
    - [ ] Integrate with centralized config and logger
    - [ ] Standardize error handling and responses
  - [ ] Refactor WorkspaceService to implement IWorkspaceService
    - [ ] Update method signatures to match interface
    - [ ] Integrate with centralized config and logger
    - [ ] Standardize error handling and responses

- [ ] **Phase 3: Implement Dependency Injection** (AC: 1)
  - [ ] Create service container for dependency injection
  - [ ] Update all service consumers to use container
  - [ ] Remove direct service instantiation throughout codebase
  - [ ] Ensure consistent service lifecycle management

- [ ] **Phase 4: Replace Legacy Logging and Error Handling** (AC: 3, 4)
  - [ ] Replace all console.log/error with structured logger
  - [ ] Implement standardized error classification system
  - [ ] Add correlation IDs to all service operations
  - [ ] Update error response formats across all endpoints

## Dev Notes

### Context from Previous Story
Story 3.6: Interactive Web Terminal Implementation foi completada com sucesso, estabelecendo uma base
sólida de WebSocket e gerenciamento de sessões que será aproveitada nesta refatoração. A arquitetura atual
funciona bem, mas precisa de melhorias na padronização e manutenibilidade.

### Architecture-Based Implementation Details

#### Service Interface Pattern
Implementar interfaces TypeScript para todos os serviços principais:
```typescript
// Example interface structure for app/types/services.ts
interface IUserService {
  findById(id: string): Promise<User | null>;
  findByEmail(email: string): Promise<User | null>;
  create(userData: CreateUserData): Promise<User>;
  update(id: string, userData: UpdateUserData): Promise<User>;
  delete(id: string): Promise<void>;
}
```

#### Configuration Structure
```typescript
// app/lib/config.ts
export const CONFIG = {
  server: {
    port: Number(process.env.PORT) || 8080,
    websocketPort: Number(process.env.WS_PORT) || 8000,
  },
  terminal: {
    maxInactivityMs: 30 * 60 * 1000,
    cleanupIntervalMs: 60 * 1000,
    maxSessions: 10,
  },
  files: {
    maxSizeBytes: 10 * 1024 * 1024,
    allowedExtensions: ['.js', '.ts', '.tsx', '.jsx', '.json', '.md'],
  },
  auth: {
    saltRounds: 12,
    sessionMaxAge: 7 * 24 * 60 * 60 * 1000, // 7 days
  },
} as const;
```

#### Logger Interface
```typescript
// app/lib/logger.ts
interface LogContext {
  userId?: string;
  sessionId?: string;
  workspacePath?: string;
  [key: string]: any;
}

interface ILogger {
  info(message: string, context?: LogContext): void;
  warn(message: string, context?: LogContext): void;
  error(message: string, error?: Error, context?: LogContext): void;
  debug(message: string, context?: LogContext): void;
}
```

#### File Locations Based on Project Structure
- **Service Interfaces**: `app/types/services.ts`
- **Configuration Module**: `app/lib/config.ts`
- **Logger Implementation**: `app/lib/logger.ts`
- **Service Container**: `app/lib/service-container.ts`
- **Existing Services**: `app/lib/services/` (refactor in place)

#### Technical Constraints
- Manter compatibilidade com sistema de autenticação existente
- Preservar funcionalidade de terminal WebSocket atual
- Manter >90% de cobertura de testes existentes
- Implementar mudanças de forma incremental para evitar breaking changes

### Testing

#### Testing Standards
- **Test File Location**: Arquivos de teste devem estar co-localizados com os módulos correspondentes usando padrão `.test.ts`
- **Testing Framework**: Jest para testes unitários e de integração
- **Test Standards**:
  - Testes unitários para todas as interfaces de serviços
  - Testes de integração para service container
  - Testes de API para verificar que endpoints continuam funcionando
- **Specific Requirements**:
  - Validar que todas as interfaces são implementadas corretamente
  - Testar injeção de dependência funciona adequadamente
  - Verificar que logging estruturado funciona em todos os contextos
  - Confirmar que tratamento de erro padronizado funciona consistentemente

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-22 | 1.0 | Story refactored to Scrum Master format | Claude Code |

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*A ser preenchido pelo dev agent*

### Debug Log References
*A ser preenchido pelo dev agent*

### Completion Notes List
*A ser preenchido pelo dev agent*

### File List
*A ser preenchido pelo dev agent*

## QA Results

*Esta seção será preenchida pelo agente de QA após revisão da implementação*