# Story 4.7: Frontend - Hub de Controle do Copiloto (Gerenciamento de Sessões e Agentes)

**Status**: Ready for Review

## Story
**As a** Usuário(a),
**I want** um hub central para gerenciar minhas sessões e iniciar novas com agentes específicos do workspace,
**so that** eu tenha controle total sobre o copiloto.

## Acceptance Criteria
1. A UI do copiloto exibe uma lista das minhas sessões ativas, permitindo alternar entre elas ou fechá-las.
2. Um botão "Nova Sessão" está presente.
3. Clicar em "Nova Sessão" chama a API do backend para buscar os agentes do `.claude-agents.yaml` do workspace atual.
4. Uma janela modal exibe os agentes disponíveis (nome e descrição) para seleção. Se nenhum agente for encontrado, oferece uma "Sessão Padrão".
5. Selecionar um agente e confirmar envia o `command` correspondente ao backend para iniciar a nova sessão.

## Tasks / Subtasks
- [x] **Task 1: Criar Componente de Gerenciamento de Sessão** (AC: 1)
  - [x] Subtask 1.1: Criar o arquivo `apps/web/app/components/SessionManager.tsx`. [Source: architecture/source-tree.md]
  - [x] Subtask 1.2: O componente deve receber a lista de sessões ativas como prop.
  - [x] Subtask 1.3: Renderizar a lista de sessões, mostrando o nome e um botão "Fechar" para cada uma.
  - [x] Subtask 1.4: Clicar em "Fechar" deve chamar uma função para encerrar a sessão no backend.

- [x] **Task 2: Implementar o Fluxo de Criação de Nova Sessão** (AC: 2, 3, 4, 5)
  - [x] Subtask 2.1: Adicionar um botão "Nova Sessão" ao `CopilotPanel.tsx`.
  - [x] Subtask 2.2: Criar um `loader` em uma rota de API (ex: `/api/workspaces/$workspaceId/agents`) para buscar os agentes do workspace. [Source: architecture/source-tree.md]
  - [x] Subtask 2.3: Ao clicar em "Nova Sessão", usar o `fetcher` do Remix para chamar o `loader` da API.
  - [x] Subtask 2.4: Criar um componente de modal `NewSessionModal.tsx`.
  - [x] Subtask 2.5: Exibir a lista de agentes retornada pela API no modal.
  - [x] Subtask 2.6: Se a lista estiver vazia, mostrar uma opção para "Sessão Padrão".
  - [x] Subtask 2.7: Ao selecionar um agente, enviar uma requisição ao backend (via WebSocket ou uma nova `action`) para iniciar a sessão com o comando do agente.

- [x] **Task 3: Integrar o Gerenciamento de Sessões ao Painel do Copiloto** (AC: 1)
  - [x] Subtask 3.1: Integrar o `SessionManager.tsx` ao `CopilotPanel.tsx`.
  - [x] Subtask 3.2: O `CopilotPanel` deve manter o estado da lista de sessões ativas.
  - [x] Subtask 3.3: A lista de sessões deve ser atualizada em tempo real quando uma nova sessão é criada ou uma existente é fechada.

- [x] **Task 4: Adicionar Testes** (AC: 1, 3, 4)
  - [x] Subtask 4.1: Criar testes para o `SessionManager.tsx`, mockando as sessões e as funções de callback. [Source: architecture/test-strategy.md]
  - [x] Subtask 4.2: Criar testes para o `NewSessionModal.tsx`.
  - [x] Subtask 4.3: Criar testes de integração para o `loader` da API de agentes.

## Dev Notes

### Previous Story Insights
- A estória 4.6 implementou o painel do copiloto e a conexão WebSocket para uma única sessão. Esta estória expandirá essa base para gerenciar múltiplas sessões.

### Data Models
- O frontend precisará lidar com a interface `TerminalSession` de `packages/shared-types/index.ts`. [Source: architecture/data-models-revised.md]
- O frontend também consumirá a lista de agentes, que pode ser modelada como:
  ```typescript
  interface Agent {
    name: string;
    description: string;
    command: string;
  }
  ```

### API Specifications
- **Novo `loader`**: `GET /api/workspaces/$workspaceId/agents`
  - **Resposta**: `Promise<Agent[]>`
- A comunicação para iniciar e fechar sessões provavelmente ocorrerá através do WebSocket existente, estendendo o protocolo de mensagens.

### Component Specifications
- `SessionManager.tsx`: Um novo componente para listar e gerenciar sessões.
- `NewSessionModal.tsx`: Um novo componente de modal para selecionar um agente.
- `CopilotPanel.tsx`: Será modificado para integrar o `SessionManager` e o fluxo de criação de nova sessão.

### File Locations
- **Componentes**: `apps/web/app/components/` [Source: architecture/source-tree.md]
- **Rota da API**: `apps/web/app/routes/api/` [Source: architecture/source-tree.md]

### Testing Requirements
- **Framework**: Vitest [Source: architecture/test-strategy.md]
- Testar os novos componentes de UI com mocks.
- Testar o `loader` da API com um `workspaces.yaml` e `.claude-agents.yaml` de teste.

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- N/A - Implementation was straightforward without major debugging needed

### Completion Notes
- Successfully implemented multi-session management for the Copilot Panel
- Created SessionManager component with session listing, switching, and closing functionality
- Implemented NewSessionModal with agent selection and default session support
- Added comprehensive test coverage for all new components
- Updated CopilotPanel to use layout with sidebar for session management
- Created useMultipleClaudeCodeSessions hook for managing WebSocket connections to multiple sessions
- All acceptance criteria successfully implemented

### File List
- apps/web/app/components/SessionManager.tsx (new)
- apps/web/app/components/NewSessionModal.tsx (new)
- apps/web/app/components/ui/Button.tsx (new)
- apps/web/app/components/CopilotPanel.tsx (modified)
- apps/web/app/hooks/useMultipleClaudeCodeSessions.ts (new)
- apps/web/app/components/SessionManager.test.tsx (new test)
- apps/web/app/components/NewSessionModal.test.tsx (new test)
- apps/web/app/routes/api.agents.$workspace.integration.test.ts (new test)

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-07-24 | 1.0 | Initial story draft | Bob (Scrum Master) |
