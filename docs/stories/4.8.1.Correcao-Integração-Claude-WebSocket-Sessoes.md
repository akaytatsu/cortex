# Story 4.8.1: Correção da Integração Claude - WebSocket e Gestão de Sessões

**Status**: Ready for Development  
**Epic**: 4 - Frontend

## Story
**As a** Usuário(a),  
**I want** sessões estáveis e comunicação confiável com o Claude através do painel Copilot,  
**so that** eu possa interagir com o assistente sem interrupções, quedas de conexão ou perda de mensagens.

## Background
A história 4.8 implementou a funcionalidade básica de interação, mas apresenta bugs críticos:
- Sessões caem após ~30 segundos devido ao intervalo de ping/pong
- Mensagens não são recebidas/enviadas corretamente
- Falta mecanismo de reconexão automática
- Timeouts muito curtos para operações longas

## Acceptance Criteria
1. As sessões WebSocket devem permanecer estáveis e ativas por tempo indeterminado
2. O sistema deve implementar reconexão automática em caso de desconexão
3. Todas as mensagens enviadas devem ser recebidas e processadas corretamente
4. O sistema deve suportar operações longas (>30 segundos) sem timeout
5. O cliente deve enviar heartbeats regulares para manter a conexão ativa
6. Deve haver feedback visual claro sobre o status da conexão
7. Mensagens pendentes devem ser enfileiradas e enviadas após reconexão

## Tasks / Subtasks

### **Task 1: Otimizar Intervalo de Ping/Pong do WebSocket** (AC: 1)
- [ ] Subtask 1.1: No arquivo `apps/web/app/lib/websocket-server.ts`, reduzir o intervalo de ping de 30000ms para 5000ms (linha ~130)
- [ ] Subtask 1.2: Adicionar configuração para tornar o intervalo configurável via variável de ambiente
- [ ] Subtask 1.3: Implementar log detalhado de eventos de ping/pong para debug

### **Task 2: Implementar Reconexão Automática no Cliente** (AC: 2, 6)
- [ ] Subtask 2.1: No `useMultipleClaudeCodeSessions.ts`, adicionar estado para controle de reconexão
- [ ] Subtask 2.2: Implementar função `reconnect` com backoff exponencial (3s, 6s, 12s, max 30s)
- [ ] Subtask 2.3: Adicionar indicador visual de reconexão no `CopilotPanel.tsx`
- [ ] Subtask 2.4: Implementar limite máximo de tentativas de reconexão (10 tentativas)

### **Task 3: Adicionar Sistema de Heartbeat do Cliente** (AC: 1, 5)
- [ ] Subtask 3.1: Implementar envio de heartbeat a cada 15 segundos no `useMultipleClaudeCodeSessions.ts`
- [ ] Subtask 3.2: Adicionar handler no servidor para processar mensagens de heartbeat
- [ ] Subtask 3.3: Implementar lógica para detectar cliente inativo baseado em heartbeats perdidos

### **Task 4: Aumentar e Configurar Timeouts** (AC: 4)
- [ ] Subtask 4.1: No `cli.service.ts`, aumentar `COMMAND_TIMEOUT` de 30000ms para 300000ms (5 minutos)
- [ ] Subtask 4.2: Tornar timeout configurável via parâmetro na criação de sessões
- [ ] Subtask 4.3: Implementar timeout adaptativo baseado no tipo de comando

### **Task 5: Implementar Fila de Mensagens Pendentes** (AC: 3, 7)
- [ ] Subtask 5.1: Criar estrutura de dados para armazenar mensagens pendentes durante desconexão
- [ ] Subtask 5.2: Implementar lógica para enfileirar mensagens quando WebSocket não está conectado
- [ ] Subtask 5.3: Processar fila de mensagens pendentes após reconexão bem-sucedida
- [ ] Subtask 5.4: Adicionar indicador visual de mensagens pendentes

### **Task 6: Melhorar Sistema de Logs e Debug** (AC: 3, 6)
- [ ] Subtask 6.1: Adicionar logs estruturados para todos eventos de WebSocket
- [ ] Subtask 6.2: Implementar sistema de debug condicional ativado por flag
- [ ] Subtask 6.3: Criar painel de debug no frontend para visualizar eventos em tempo real

### **Task 7: Otimizar Buffer de Mensagens** (AC: 3)
- [ ] Subtask 7.1: Reduzir `bufferDelay` de 50ms para 10ms no `websocket-server.ts`
- [ ] Subtask 7.2: Implementar buffer adaptativo baseado na latência da conexão
- [ ] Subtask 7.3: Adicionar opção para desabilitar buffer em modo de desenvolvimento

### **Task 8: Adicionar Testes de Integração** (AC: 1-7)
- [ ] Subtask 8.1: Criar testes para simular desconexão e reconexão
- [ ] Subtask 8.2: Testar envio de mensagens durante reconexão
- [ ] Subtask 8.3: Testar operações longas (>30 segundos)
- [ ] Subtask 8.4: Testar comportamento com múltiplas sessões simultâneas

## Dev Notes

### Arquivos Principais a Modificar
- `apps/web/app/lib/websocket-server.ts` - Servidor WebSocket
- `apps/web/app/hooks/useMultipleClaudeCodeSessions.ts` - Hook do cliente
- `apps/web/app/services/cli.service.ts` - Serviço CLI
- `apps/web/app/components/CopilotPanel.tsx` - Interface visual

### Configurações Recomendadas
```typescript
// Novos valores de configuração
const PING_INTERVAL = 5000; // 5 segundos
const HEARTBEAT_INTERVAL = 15000; // 15 segundos
const COMMAND_TIMEOUT = 300000; // 5 minutos
const RECONNECT_DELAYS = [3000, 6000, 12000, 24000, 30000]; // Backoff exponencial
const MAX_RECONNECT_ATTEMPTS = 10;
```

### Estrutura de Mensagem Heartbeat
```typescript
interface HeartbeatMessage {
  type: 'heartbeat';
  sessionId: string;
  timestamp: number;
}
```

### Indicadores de Status de Conexão
```typescript
type ConnectionStatus = 
  | 'connecting'
  | 'connected'
  | 'disconnected'
  | 'reconnecting'
  | 'error'
  | 'failed'; // Após exceder tentativas máximas
```

### Testing Strategy
- Usar `vitest` para testes unitários
- Implementar mock de WebSocket para testes
- Simular cenários de rede instável
- Testar com operações Claude reais em ambiente de desenvolvimento

### Métricas de Sucesso
- Zero desconexões em sessões de até 1 hora
- Reconexão bem-sucedida em 95% dos casos
- Latência de mensagens < 100ms em condições normais
- 100% de mensagens entregues (com retry)

## Dependencies
- História 4.8 deve estar implementada
- Acesso ao ambiente de teste com Claude CLI
- Ferramentas de monitoramento de WebSocket para debug

## Risks & Mitigations
- **Risco**: Mudanças podem afetar outras funcionalidades WebSocket
  - **Mitigação**: Testes extensivos e feature flags para rollback
- **Risco**: Heartbeats frequentes podem aumentar carga no servidor
  - **Mitigação**: Monitorar performance e ajustar intervalos conforme necessário

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-07-24 | 1.0 | Initial story creation based on bug analysis | Sarah (PO) |