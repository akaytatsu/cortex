# Story 4.6: Frontend - Painel do Copiloto e Exibicao em Tempo Real

**Status**: Approved

## Story
**As a** Usuário(a),
**I want** um painel de copiloto elegante que exiba a saída da minha sessão `claude code` em tempo real,
**so that** a interação seja fluida e conversacional.

## Acceptance Criteria
1. Um painel dedicado ao copiloto existe no layout da IDE, com design inspirado no Conductor.
2. Ao selecionar uma sessão ativa, o painel estabelece uma **conexão WebSocket segura e autenticada**.
3. Mensagens recebidas via WebSocket são renderizadas de forma formatada (suportando markdown) na área de saída.
4. Um indicador visual de "processando" é exibido enquanto o backend executa um comando.
5. **O painel exibe mensagens de erro claras** se a conexão WebSocket falhar ou for encerrada inesperadamente.
6. **O layout do painel é responsivo** e funcional em telas menores, seguindo a abordagem "mobile-first" do projeto.

## Tasks / Subtasks
- [ ] **Task 1: Criar o Componente do Painel do Copiloto** (AC: 1, 6)
  - [ ] Subtask 1.1: Criar o arquivo `apps/web/app/components/CopilotPanel.tsx`. [Source: architecture/source-tree.md]
  - [ ] Subtask 1.2: Desenvolver o layout básico usando componentes `shadcn/ui` (ex: Card, ScrollArea). [Source: architecture/tech-stack.md]
  - [ ] Subtask 1.3: Integrar o painel ao layout principal da IDE (provavelmente na rota `workspaces/{name}`).
  - [ ] Subtask 1.4: Adicionar uma área de placeholder para a exibição da saída.
  - [ ] Subtask 1.5: Adicionar um placeholder para o indicador de "processando".
  - [ ] Subtask 1.6: Garantir que o layout do painel seja flexível e se adapte a diferentes larguras de tela (CSS Flexbox/Grid).

- [ ] **Task 2: Implementar o Gerenciamento da Conexão WebSocket Segura** (AC: 2, 5)
  - [ ] Subtask 2.1: Criar um hook customizado `useCopilotWebSocket(sessionId)` em `apps/web/app/hooks/`. [Source: architecture/coding-standards.md]
  - [ ] Subtask 2.2: O hook deve inicializar uma conexão WebSocket com o servidor, **incluindo um token de autenticação (ex: JWT) como parâmetro de consulta**.
  - [ ] Subtask 2.3: O hook deve tratar os eventos `onopen`, `onmessage`, `onerror`, e `onclose`.
  - [ ] Subtask 2.4: O hook deve expor o status da conexão (ex: 'connecting', 'open', 'closed', 'error') e a última mensagem recebida.
  - [ ] Subtask 2.5: O hook deve limpar a conexão quando o componente for desmontado ou o `sessionId` mudar.
  - [ ] Subtask 2.6: Em caso de erro (`onerror`) ou fechamento inesperado (`onclose`), o hook deve expor uma mensagem de erro apropriada.

- [ ] **Task 3: Implementar a Exibição da Saída em Tempo Real e Tratamento de Erros** (AC: 3, 5)
  - [ ] Subtask 3.1: No `CopilotPanel.tsx`, usar o hook `useCopilotWebSocket`.
  - [ ] Subtask 3.2: Armazenar as mensagens recebidas em um array de estado (ex: `useState([])`).
  - [ ] Subtask 3.3: Renderizar o array de mensagens na área de saída.
  - [ ] Subtask 3.4: Usar uma biblioteca como `react-markdown` para renderizar mensagens que contenham markdown.
  - [ ] Subtask 3.5: Garantir que a área de saída role automaticamente para o final com novas mensagens.
  - [ ] Subtask 3.6: Se o status da conexão do hook for 'error', exibir um componente de erro visual no painel.

- [ ] **Task 4: Implementar o Indicador de "Processando"** (AC: 4)
  - [ ] Subtask 4.1: O protocolo WebSocket deve ser estendido para incluir tipos de mensagem para 'start_processing' e 'end_processing'.
  - [ ] Subtask 4.2: O hook `useCopilotWebSocket` deve gerenciar um estado `isProcessing` com base nessas mensagens.
  - [ ] Subtask 4.3: No `CopilotPanel.tsx`, exibir um indicador visual (ex: um spinner ou um ponto pulsante dos `Lucide Icons`) quando `isProcessing` for verdadeiro. [Source: architecture/tech-stack.md]

- [ ] **Task 5: Adicionar Testes Unitários e de Componentes**
  - [ ] Subtask 5.1: Criar o arquivo de teste `apps/web/app/components/CopilotPanel.test.tsx`. [Source: architecture/coding-standards.md]
  - [ ] Subtask 5.2: Escrever testes para o componente `CopilotPanel`, mockando o hook `useCopilotWebSocket`.
  - [ ] Subtask 5.3: Testar se as mensagens são renderizadas corretamente.
  - [ ] Subtask 5.4: Testar se o indicador de processamento aparece e desaparece com base no estado do hook mockado.
  - [ ] Subtask 5.5: **Testar se a mensagem de erro é exibida quando o hook mockado retorna um estado de erro.**
  - [ ] Subtask 5.6: Criar o arquivo de teste `apps/web/app/hooks/useCopilotWebSocket.test.ts`.
  - [ ] Subtask 5.7: Escrever testes para o hook customizado, mockando a API nativa do WebSocket e a lógica de autenticação.

## Dev Notes

### Previous Story Insights
- As histórias de backend 4.1-4.5 estabeleceram o servidor WebSocket, o gerenciamento de processos e a persistência de sessão. O frontend pode assumir que estes estão funcionais. O protocolo de mensagens WebSocket (`iniciar_sessao`, `enviar_comando`, `receber_output`, `sessao_encerrada`) está definido.

### Data Models
- O frontend precisará tratar a interface `TerminalMessage` de `packages/shared-types/index.ts`. [Source: architecture/data-models-revised.md]
  ```typescript
  export interface TerminalMessage {
    type: 'input' | 'output' | 'error' | 'exit';
    data: string;
    sessionId: string;
  }
  ```
- **Suposição:** O protocolo será estendido para incluir os tipos `start_processing` e `end_processing` para controlar o indicador da UI.

### API Specifications
- Não há novos endpoints REST. Toda a comunicação é via WebSockets.
- **WebSocket Security:** A conexão WebSocket deve ser autenticada. O cliente deve enviar um token (obtido durante a sessão de login HTTP) como um parâmetro de consulta ao conectar (ex: `wss://your-domain.com/ws?token=...`). O servidor WebSocket **deve** validar este token antes de estabelecer a conexão e associá-la ao `userId` correto.

### Component Specifications
- `CopilotPanel.tsx`: Um novo componente de contêiner.
- Deve usar `shadcn/ui` para o layout (ex: `Card`, `ScrollArea`) e `Lucide Icons` para quaisquer ícones. [Source: architecture/tech-stack.md]
- **Responsiveness**: O componente deve usar princípios de design responsivo para garantir a usabilidade em telas de desktop e mobile.

### File Locations
- **Componente**: `apps/web/app/components/CopilotPanel.tsx` [Source: architecture/source-tree.md]
- **Hook**: `apps/web/app/hooks/useCopilotWebSocket.ts` [Source: architecture/coding-standards.md]
- **Testes**: `apps/web/app/components/CopilotPanel.test.tsx`, `apps/web/app/hooks/useCopilotWebSocket.test.ts` [Source: architecture/coding-standards.md]

### Testing Requirements
- **Framework**: Vitest [Source: architecture/test-strategy.md]
- **Cobertura**: >80% para a lógica do novo hook e componente. [Source: architecture/test-strategy.md]
- Mockar a API do WebSocket para os testes do hook.
- Mockar o hook `useCopilotWebSocket` para os testes do componente.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-07-24 | 1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-07-24 | 1.1 | Added security, error handling, and responsiveness requirements. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
_TBD by Dev Agent_

### Debug Log References
_TBD by Dev Agent_

### Completion Notes List
_TBD by Dev Agent_

### File List
_TBD by Dev Agent_

## QA Results
_TBD by QA Agent_
