# Story 4.6: Frontend - Painel do Copiloto e Exibicao em Tempo Real

**Status**: Ready for Review

## Story
**As a** UsuÃ¡rio(a),
**I want** um painel de copiloto elegante que exiba a saÃ­da da minha sessÃ£o `claude code` em tempo real,
**so that** a interaÃ§Ã£o seja fluida e conversacional.

## Acceptance Criteria
1. Um painel dedicado ao copiloto existe no layout da IDE, com design inspirado no Conductor.
2. Ao selecionar uma sessÃ£o ativa, o painel estabelece uma **conexÃ£o WebSocket segura e autenticada**.
3. Mensagens recebidas via WebSocket sÃ£o renderizadas de forma formatada (suportando markdown) na Ã¡rea de saÃ­da.
4. Um indicador visual de "processando" Ã© exibido enquanto o backend executa um comando.
5. **O painel exibe mensagens de erro claras** se a conexÃ£o WebSocket falhar ou for encerrada inesperadamente.
6. **O layout do painel Ã© responsivo** e funcional em telas menores, seguindo a abordagem "mobile-first" do projeto.

## Tasks / Subtasks
- [x] **Task 1: Criar o Componente do Painel do Copiloto** (AC: 1, 6)
  - [x] Subtask 1.1: Criar o arquivo `apps/web/app/components/CopilotPanel.tsx`. [Source: architecture/source-tree.md]
  - [x] Subtask 1.2: Desenvolver o layout bÃ¡sico usando componentes `shadcn/ui` (ex: Card, ScrollArea). [Source: architecture/tech-stack.md]
  - [x] Subtask 1.3: Integrar o painel ao layout principal da IDE (provavelmente na rota `workspaces/{name}`).
  - [x] Subtask 1.4: Adicionar uma Ã¡rea de placeholder para a exibiÃ§Ã£o da saÃ­da.
  - [x] Subtask 1.5: Adicionar um placeholder para o indicador de "processando".
  - [x] Subtask 1.6: Garantir que o layout do painel seja flexÃ­vel e se adapte a diferentes larguras de tela (CSS Flexbox/Grid).

- [x] **Task 2: Implementar o Gerenciamento da ConexÃ£o WebSocket Segura** (AC: 2, 5)
  - [x] Subtask 2.1: Criar um hook customizado `useCopilotWebSocket(sessionId)` em `apps/web/app/hooks/`. [Source: architecture/coding-standards.md]
  - [x] Subtask 2.2: O hook deve inicializar uma conexÃ£o WebSocket com o servidor, **incluindo um token de autenticaÃ§Ã£o (ex: JWT) como parÃ¢metro de consulta**.
  - [x] Subtask 2.3: O hook deve tratar os eventos `onopen`, `onmessage`, `onerror`, e `onclose`.
  - [x] Subtask 2.4: O hook deve expor o status da conexÃ£o (ex: 'connecting', 'open', 'closed', 'error') e a Ãºltima mensagem recebida.
  - [x] Subtask 2.5: O hook deve limpar a conexÃ£o quando o componente for desmontado ou o `sessionId` mudar.
  - [x] Subtask 2.6: Em caso de erro (`onerror`) ou fechamento inesperado (`onclose`), o hook deve expor uma mensagem de erro apropriada.

- [x] **Task 3: Implementar a ExibiÃ§Ã£o da SaÃ­da em Tempo Real e Tratamento de Erros** (AC: 3, 5)
  - [x] Subtask 3.1: No `CopilotPanel.tsx`, usar o hook `useCopilotWebSocket`.
  - [x] Subtask 3.2: Armazenar as mensagens recebidas em um array de estado (ex: `useState([])`).
  - [x] Subtask 3.3: Renderizar o array de mensagens na Ã¡rea de saÃ­da.
  - [x] Subtask 3.4: Usar uma biblioteca como `react-markdown` para renderizar mensagens que contenham markdown.
  - [x] Subtask 3.5: Garantir que a Ã¡rea de saÃ­da role automaticamente para o final com novas mensagens.
  - [x] Subtask 3.6: Se o status da conexÃ£o do hook for 'error', exibir um componente de erro visual no painel.

- [x] **Task 4: Implementar o Indicador de "Processando"** (AC: 4)
  - [x] Subtask 4.1: O protocolo WebSocket deve ser estendido para incluir tipos de mensagem para 'start_processing' e 'end_processing'.
  - [x] Subtask 4.2: O hook `useCopilotWebSocket` deve gerenciar um estado `isProcessing` com base nessas mensagens.
  - [x] Subtask 4.3: No `CopilotPanel.tsx`, exibir um indicador visual (ex: um spinner ou um ponto pulsante dos `Lucide Icons`) quando `isProcessing` for verdadeiro. [Source: architecture/tech-stack.md]

- [x] **Task 5: Adicionar Testes UnitÃ¡rios e de Componentes**
  - [x] Subtask 5.1: Criar o arquivo de teste `apps/web/app/components/CopilotPanel.test.tsx`. [Source: architecture/coding-standards.md]
  - [x] Subtask 5.2: Escrever testes para o componente `CopilotPanel`, mockando o hook `useCopilotWebSocket`.
  - [x] Subtask 5.3: Testar se as mensagens sÃ£o renderizadas corretamente.
  - [x] Subtask 5.4: Testar se o indicador de processamento aparece e desaparece com base no estado do hook mockado.
  - [x] Subtask 5.5: **Testar se a mensagem de erro Ã© exibida quando o hook mockado retorna um estado de erro.**
  - [x] Subtask 5.6: Criar o arquivo de teste `apps/web/app/hooks/useCopilotWebSocket.test.tsx`.
  - [x] Subtask 5.7: Escrever testes para o hook customizado, mockando a API nativa do WebSocket e a lÃ³gica de autenticaÃ§Ã£o.

## Dev Notes

### Previous Story Insights
- As histÃ³rias de backend 4.1-4.5 estabeleceram o servidor WebSocket, o gerenciamento de processos e a persistÃªncia de sessÃ£o. O frontend pode assumir que estes estÃ£o funcionais. O protocolo de mensagens WebSocket (`iniciar_sessao`, `enviar_comando`, `receber_output`, `sessao_encerrada`) estÃ¡ definido.

### Data Models
- O frontend precisarÃ¡ tratar a interface `TerminalMessage` de `packages/shared-types/index.ts`. [Source: architecture/data-models-revised.md]
  ```typescript
  export interface TerminalMessage {
    type: 'input' | 'output' | 'error' | 'exit';
    data: string;
    sessionId: string;
  }
  ```
- **SuposiÃ§Ã£o:** O protocolo serÃ¡ estendido para incluir os tipos `start_processing` e `end_processing` para controlar o indicador da UI.

### API Specifications
- NÃ£o hÃ¡ novos endpoints REST. Toda a comunicaÃ§Ã£o Ã© via WebSockets.
- **WebSocket Security:** A conexÃ£o WebSocket deve ser autenticada. O cliente deve enviar um token (obtido durante a sessÃ£o de login HTTP) como um parÃ¢metro de consulta ao conectar (ex: `wss://your-domain.com/ws?token=...`). O servidor WebSocket **deve** validar este token antes de estabelecer a conexÃ£o e associÃ¡-la ao `userId` correto.

### Component Specifications
- `CopilotPanel.tsx`: Um novo componente de contÃªiner.
- Deve usar `shadcn/ui` para o layout (ex: `Card`, `ScrollArea`) e `Lucide Icons` para quaisquer Ã­cones. [Source: architecture/tech-stack.md]
- **Responsiveness**: O componente deve usar princÃ­pios de design responsivo para garantir a usabilidade em telas de desktop e mobile.

### File Locations
- **Componente**: `apps/web/app/components/CopilotPanel.tsx` [Source: architecture/source-tree.md]
- **Hook**: `apps/web/app/hooks/useCopilotWebSocket.ts` [Source: architecture/coding-standards.md]
- **Testes**: `apps/web/app/components/CopilotPanel.test.tsx`, `apps/web/app/hooks/useCopilotWebSocket.test.ts` [Source: architecture/coding-standards.md]

### Testing Requirements
- **Framework**: Vitest [Source: architecture/test-strategy.md]
- **Cobertura**: >80% para a lÃ³gica do novo hook e componente. [Source: architecture/test-strategy.md]
- Mockar a API do WebSocket para os testes do hook.
- Mockar o hook `useCopilotWebSocket` para os testes do componente.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-07-24 | 1.0 | Initial story draft | Bob (Scrum Master) |
| 2025-07-24 | 1.1 | Added security, error handling, and responsiveness requirements. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- ImplementaÃ§Ã£o realizada atravÃ©s do agente dev (James ðŸ’»)
- Todos os arquivos criados e testados com sucesso
- Testes unitÃ¡rios criados para componente e hook

### Completion Notes List
- âœ… Componente CopilotPanel criado com design responsivo usando Card/ScrollArea
- âœ… Hook useCopilotWebSocket implementado com gerenciamento completo de estado WebSocket
- âœ… IntegraÃ§Ã£o ao IDELayout adicionada com painel lateral redimensionÃ¡vel
- âœ… Sistema de mensagens com suporte a markdown e tipos de mensagem diferenciados
- âœ… Indicador visual de processamento implementado
- âœ… Tratamento de erros com exibiÃ§Ã£o visual clara
- âœ… Scroll automÃ¡tico para novas mensagens
- âœ… Interface ClaudeCodeMessage estendida com tipos start_processing/end_processing
- âœ… Componentes shadcn/ui bÃ¡sicos criados (Card, ScrollArea)
- âœ… Testes unitÃ¡rios abrangentes para componente e hook
- âœ… Layout responsivo com abordagem mobile-first

### File List
- `/apps/web/app/components/CopilotPanel.tsx` - Componente principal do painel
- `/apps/web/app/components/CopilotPanel.test.tsx` - Testes do componente
- `/apps/web/app/hooks/useCopilotWebSocket.ts` - Hook para gerenciamento WebSocket
- `/apps/web/app/hooks/useCopilotWebSocket.test.tsx` - Testes do hook
- `/apps/web/app/components/ui/Card.tsx` - Componente Card shadcn/ui
- `/apps/web/app/components/ui/ScrollArea.tsx` - Componente ScrollArea shadcn/ui
- `/apps/web/app/lib/utils.ts` - UtilitÃ¡rios para classes CSS
- `/apps/web/app/components/IDELayout.tsx` - Layout principal (modificado)
- `/packages/shared-types/index.ts` - Interface ClaudeCodeMessage (modificada)

## QA Results
_TBD by QA Agent_
