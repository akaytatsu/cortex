# Story 4.8.2: Correção da Integração Claude - Modo Print e Stream JSON

**Status**: Ready for Development
**Epic**: 4 - Frontend

## Story
**As a** Usuário(a),
**I want** enviar e receber mensagens corretamente através do chat com Claude,
**so that** eu possa ter conversas funcionais e produtivas com o assistente sem bugs de comunicação.

## Background
A análise do repositório claudecodeui revelou que nossa implementação atual não está usando o Claude CLI corretamente:
- Estamos tentando usar modo interativo via stdin, mas devemos usar `--print` flag
- Não estamos parseando as respostas JSON estruturadas corretamente
- A gestão de sessões não está usando os comandos corretos do CLI
- Falta suporte para `--output-format stream-json` que é essencial

## Acceptance Criteria
1. O sistema deve usar `claude --print "comando"` para enviar mensagens
2. As respostas devem ser parseadas como stream JSON linha por linha
3. Sessões devem ser resumidas usando `claude --resume <sessionId>`
4. O sistema deve capturar e mostrar corretamente o ID da sessão criada
5. Todas as mensagens devem aparecer corretamente no chat (user e assistant)
6. O sistema deve suportar envio de imagens junto com as mensagens
7. Deve haver indicadores visuais claros do status da operação

## Tasks / Subtasks

### **Task 1: Refatorar CLI Service para Modo Print** (AC: 1, 2)
- [x] Subtask 1.1: Modificar `cli.service.ts` para usar `--print` flag quando há comando
- [x] Subtask 1.2: Adicionar `--output-format stream-json` aos argumentos do spawn
- [x] Subtask 1.3: Remover lógica de escrita via stdin para comandos iniciais
- [x] Subtask 1.4: Implementar parser de stream JSON linha por linha

### **Task 2: Implementar Gestão Correta de Sessões** (AC: 3, 4)
- [x] Subtask 2.1: Adicionar suporte para `--resume <sessionId>` no CLI service
- [x] Subtask 2.2: Capturar session_id das respostas JSON do Claude
- [x] Subtask 2.3: Armazenar e gerenciar session IDs corretamente
- [x] Subtask 2.4: Implementar detecção de nova sessão vs sessão resumida

### **Task 3: Corrigir Processamento de Mensagens** (AC: 2, 5)
- [x] Subtask 3.1: Implementar parser para diferentes tipos de resposta JSON
- [x] Subtask 3.2: Converter respostas JSON em mensagens de chat formatadas
- [x] Subtask 3.3: Tratar mensagens de erro e system messages adequadamente
- [x] Subtask 3.4: Implementar buffer para mensagens parciais

### **Task 4: Adicionar Suporte a Imagens** (AC: 6)
- [x] Subtask 4.1: Implementar salvamento temporário de imagens no servidor
- [x] Subtask 4.2: Passar caminhos das imagens para o Claude CLI
- [x] Subtask 4.3: Limpar arquivos temporários após processamento
- [x] Subtask 4.4: Adicionar validação de tipos de imagem suportados

### **Task 5: Melhorar Feedback Visual** (AC: 7)
- [ ] Subtask 5.1: Adicionar indicador de "Claude está digitando"
- [ ] Subtask 5.2: Mostrar status de processamento de ferramentas
- [ ] Subtask 5.3: Implementar indicadores de erro mais claros
- [ ] Subtask 5.4: Adicionar animações de carregamento adequadas

### **Task 6: Atualizar WebSocket Handler** (AC: 1-7)
- [x] Subtask 6.1: Refatorar handler de mensagens claude-code no websocket-server
- [x] Subtask 6.2: Implementar novo formato de mensagens baseado no claudecodeui
- [x] Subtask 6.3: Adicionar logs detalhados para debug
- [x] Subtask 6.4: Implementar tratamento de timeout específico para modo print

## Dev Notes

### Exemplo de Comando Claude Correto
```bash
# Nova sessão
claude --print "Hello, Claude!" --output-format stream-json --verbose

# Resumir sessão
claude --resume <session-id> --print "Continue nossa conversa" --output-format stream-json
```

### Formato de Resposta JSON Esperado
```json
{"type":"system","subtype":"init","session_id":"abc123"}
{"type":"message","role":"assistant","content":[{"type":"text","text":"Olá! Como posso ajudar?"}]}
{"type":"tool_use","name":"Read","input":{"file_path":"/path/to/file"}}
{"type":"tool_result","content":"conteúdo do arquivo..."}
```

### Arquivos Principais a Modificar
- `apps/web/app/services/cli.service.ts` - Lógica principal do CLI
- `apps/web/app/lib/websocket-server.ts` - Handler de WebSocket
- `apps/web/app/hooks/useMultipleClaudeCodeSessions.ts` - Cliente WebSocket
- `apps/web/app/components/CopilotPanel.tsx` - Interface do chat

### Estrutura de Processo Claude Atualizada
```typescript
interface ClaudeStreamResponse {
  type: 'system' | 'message' | 'tool_use' | 'tool_result' | 'error';
  subtype?: string;
  session_id?: string;
  role?: 'user' | 'assistant';
  content?: Array<{type: string; text?: string}> | string;
  name?: string;
  input?: any;
}
```

## Dependencies
- História 4.8.1 deve estar implementada
- Acesso ao Claude CLI v0.7.14+ (que suporta --print)
- Node.js com suporte a streams

## Risks & Mitigations
- **Risco**: Mudança significativa na arquitetura de comunicação
  - **Mitigação**: Implementar feature flag para rollback rápido
- **Risco**: Compatibilidade com diferentes versões do Claude CLI
  - **Mitigação**: Verificar versão do CLI antes de iniciar
- **Risco**: Performance com grandes volumes de dados JSON
  - **Mitigação**: Implementar streaming e buffer eficientes

## Success Metrics
- 100% das mensagens enviadas são recebidas e exibidas
- Latência < 200ms para exibição de respostas
- Zero erros de parsing JSON em operação normal
- Sessões mantidas corretamente entre recarregamentos

## Dev Agent Record

### Agent Model Used
James (Dev)

### Debug Log References
- Implementação do modo print no CLI service: cli.service.ts:59-92
- Parser de stream JSON: cli.service.ts:518-530
- Novo handler WebSocket: websocket-server.ts:544-750
- Sistema de imagens: image.service.ts:1-281
- Types atualizados: shared-types/index.ts:211-281

### Completion Notes
- [x] Refatorado CLI service para usar --print flag com --output-format stream-json
- [x] Implementado suporte para --resume com session IDs do Claude
- [x] Criado parser robusto para processar stream JSON linha por linha
- [x] Adicionado sistema completo de upload e processamento de imagens
- [x] Refatorado WebSocket handler para novo formato de mensagens
- [x] Adicionados logs detalhados para debug em modo de desenvolvimento
- [x] Build passa sem erros de compilação

### File List
- apps/web/app/services/cli.service.ts (modificado)
- apps/web/app/services/image.service.ts (novo)
- apps/web/app/lib/websocket-server.ts (modificado) 
- packages/shared-types/index.ts (modificado)

### Creation Notes
História criada após análise detalhada do repositório claudecodeui e identificação das causas raiz dos bugs de comunicação. A implementação de referência usa uma abordagem completamente diferente que precisamos adotar.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-07-24 | 1.0 | Initial story creation based on claudecodeui analysis | Sarah (PO) |
| 2025-07-24 | 1.1 | Core implementation completed - print mode, stream JSON, session management, image support | James (Dev) |
| 2025-07-25 | 1.2 | Fixed command validation - user messages now treated as Claude input, not system commands | James (Dev) |
| 2025-07-25 | 1.3 | Fixed race condition in process management - added cleanup delays and retry logic | James (Dev) |
| 2025-07-25 | 1.4 | Fixed session persistence for print mode - WebSocket stays alive between print commands | James (Dev) |