# Story 3.2: Implement Adding and Removing Workspace Paths

## Status

Draft

## Story

**As a** logged-in user,
**I want** to add a path to a project folder as a workspace,
**so that** I can manage project access without affecting the actual files.

## Acceptance Criteria

1. "Adicionar Workspace" solicita um Nome de Exibição e um Caminho no servidor.
2. O formulário permite a) fornecer um caminho existente ou b) criar uma nova pasta.
3. O sistema valida o caminho.
4. O nome e o caminho são salvos na configuração do usuário.
5. Cada workspace tem um botão "Remover".
6. "Remover" apenas desfaz o link no dashboard, **NÃO** apaga a pasta no servidor.

## Tasks / Subtasks

- [ ] Task 1 (AC: 1, 2): Melhorar AddWorkspaceForm para suportar criação de pastas
  - [ ] Adicionar campo checkbox "Criar nova pasta" no formulário
  - [ ] Implementar lógica condicional para mostrar diferentes inputs baseado no checkbox
  - [ ] Adicionar validação client-side para ambos os modos
- [ ] Task 2 (AC: 2, 3): Implementar lógica de validação e criação de diretórios no backend
  - [ ] Estender WorkspaceService com método `validateAndCreatePath()`
  - [ ] Implementar validação de caminho existente usando Node.js fs
  - [ ] Adicionar funcionalidade de criação de diretório quando solicitado
  - [ ] Implementar tratamento de erros específicos (permissões, caminho inválido, etc.)
- [ ] Task 3 (AC: 4): Atualizar action da rota `/workspaces/new` para usar nova lógica
  - [ ] Integrar validação e criação de path na action
  - [ ] Implementar feedback adequado para diferentes tipos de erro
  - [ ] Manter redirecionamento para `/workspaces` após sucesso
- [ ] Task 4 (AC: 5, 6): Implementar funcionalidade de remoção de workspace
  - [ ] Adicionar botão "Remover" em cada workspace no componente WorkspaceList
  - [ ] Criar action para remoção em rota `/workspaces/$workspaceName/delete`
  - [ ] Implementar WorkspaceService.removeWorkspace() que apenas remove do YAML
  - [ ] Adicionar confirmação antes da remoção
- [ ] Task 5: Melhorar UX do formulário e feedback visual
  - [ ] Adicionar loading states nos formulários
  - [ ] Implementar toast notifications para ações de sucesso/erro
  - [ ] Melhorar styling e acessibilidade dos componentes
- [ ] Task 6: Testing
  - [ ] Adicionar testes para validateAndCreatePath() no WorkspaceService
  - [ ] Testar cenários de validação (path válido/inválido, permissões)
  - [ ] Criar testes para funcionalidade de remoção
  - [ ] Testar integração das novas rotas e actions
  - [ ] Verificar componentes React com novos campos e comportamentos

## Dev Notes

### Previous Story Insights

- **WorkspaceService Implementado**: Service já existe em `apps/web/app/services/workspace.service.ts` com métodos `listWorkspaces()` e `addWorkspace()` funcionais [Source: Previous Story 3.1]
- **AddWorkspaceForm Existente**: Componente já criado em `apps/web/app/components/AddWorkspaceForm.tsx` com padrão estabelecido [Source: Previous Story 3.1] 
- **Rota /workspaces/new**: Já implementada com loader/action básicos funcionais [Source: Previous Story 3.1]
- **Autenticação**: Sistema seguro com `SessionService.requireUserId()` já integrado [Source: Previous Stories 2.x, 3.1]
- **Interface Workspace**: Definida em `packages/shared-types/index.ts` como `{ name: string; path: string }` [Source: Previous Story 3.1]

### Data Models

- **Workspace Model**: Interface mantém-se como `{ name: string; path: string }` conforme definido [Source: architecture/data-models-revised.md]
- **File Storage**: Workspaces continuam persistidos em `/<cortex_root>/config/workspaces.yaml` [Source: architecture/data-models-revised.md]
- **YAML Structure**: Array de workspaces, sem mudanças estruturais necessárias [Source: architecture/data-models-revised.md]
- **Path Validation**: Novos caminhos devem ser validados antes da inserção no YAML [Source: Story Requirements]

### API Specifications

- **Workspace Endpoints**: Continuar usando padrão `loader`(leitura) e `action`(escrita) do Remix [Source: architecture/api-specification.md]
- **New Delete Action**: Criar action para remoção em rota dedicada `/workspaces/$workspaceName/delete` [Source: Story Requirements AC 5,6]
- **File System Operations**: Validação e criação de diretórios via Node.js fs padrão [Source: architecture/coding-standards.md]
- **Authentication**: Todas as rotas mantêm proteção via `SessionService.requireUserId()` [Source: architecture/api-specification.md]

### Component Specifications

- **UI Components**: Continuar usando shadcn/ui para consistência visual [Source: architecture/tech-stack.md]
- **Form Enhancement**: Estender AddWorkspaceForm existente com novos campos condicionais [Source: Previous Story 3.1]
- **Icons**: Usar Lucide Icons para botões de remoção e ações [Source: architecture/tech-stack.md]
- **Styling**: Manter Tailwind CSS 4.1.11 para estilização [Source: architecture/tech-stack.md]
- **Loading States**: Implementar feedback visual durante operações assíncronas [Source: UX Best Practices]

### File Locations

- **Service Extensions**: Estender `apps/web/app/services/workspace.service.ts` existente [Source: architecture/source-tree.md]
- **Component Updates**: Modificar `apps/web/app/components/AddWorkspaceForm.tsx` e `WorkspaceList.tsx` [Source: Previous Story 3.1]
- **New Route**: Criar `apps/web/app/routes/workspaces.$workspaceName.delete.tsx` para remoção [Source: architecture/source-tree.md]
- **Existing Routes**: Modificar `apps/web/app/routes/workspaces.new.tsx` action [Source: Previous Story 3.1]
- **Config File**: Continuar gerenciamento de `/<cortex_root>/config/workspaces.yaml` [Source: architecture/data-models-revised.md]

### Testing Requirements

- **Test Files**: Manter convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para novos métodos do WorkspaceService (validateAndCreatePath, removeWorkspace) [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para nova action de delete e validação de paths [Source: architecture/test-strategy.md]
- **File System Testing**: Usar arquivos temporários ou mocks para testes de criação de diretório [Source: architecture/test-strategy.md]
- **Coverage**: Manter >80% de cobertura na lógica de negócio crítica [Source: architecture/test-strategy.md]

### Technical Constraints

- **Language/Runtime**: Manter TypeScript 5.8, Node.js 22.x [Source: architecture/coding-standards.md]
- **Framework**: Continuar Remix 2.16.8 para rotas e componentes [Source: architecture/tech-stack.md]
- **File System**: Usar Node.js fs padrão para validação e criação de diretórios [Source: architecture/coding-standards.md]
- **Error Handling**: Usar classes de erro customizadas para diferentes tipos de falha (permissões, path inválido) [Source: architecture/coding-standards.md]
- **Service Layer**: Manter toda lógica de negócio em `apps/web/app/services/` [Source: architecture/coding-standards.md]
- **Path Security**: Implementar validação para prevenir path traversal e acessos não autorizados [Source: Security Best Practices]

### Project Structure Notes

A estrutura do projeto continua alinhada com os requisitos da story:
- Extensões do WorkspaceService em `apps/web/app/services/` conforme source-tree.md
- Modificações de componentes em `apps/web/app/components/` seguindo estrutura estabelecida
- Nova rota de delete em `apps/web/app/routes/` conforme padrões do Remix
- Interface Workspace mantida em `packages/shared-types/` sem alterações necessárias
- Gerenciamento do arquivo `workspaces.yaml` continua na localização especificada

### Testing

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para validateAndCreatePath(), removeWorkspace() e componentes modificados [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para fluxo completo de adição com validação e remoção de workspaces [Source: architecture/test-strategy.md]
- **File System Mocking**: Usar mocks do Node.js fs para testes de validação e criação de diretório [Source: architecture/test-strategy.md]
- **Error Scenario Testing**: Testar cenários de falha (permissões negadas, paths inválidos, etc.) [Source: Testing Best Practices]
- **UI Component Testing**: Testar estados condicionais do formulário e feedback visual [Source: Previous Story 3.1 patterns]

## Change Log

| Date       | Version | Description   | Author             |
| ---------- | ------- | ------------- | ------------------ |
| 2025-07-22 | 1.0     | Initial draft | Bob (Scrum Master) |