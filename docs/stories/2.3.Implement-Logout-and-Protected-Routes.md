# Story 2.3: Implement Logout and Protected Routes

## Status

Draft

## Story

**As the** logged-in user,
**I want** to log out and have my workspace protected,
**so that** my account remains secure.

## Acceptance Criteria

1. Uma funcionalidade de "Logout" destrói a sessão e redireciona para `/login`.
2. Todas as rotas (exceto `/login`, `/setup`) são protegidas.
3. Acesso não autenticado a rotas protegidas redireciona para `/login`.

## Tasks / Subtasks

- [ ] Task 1 (AC: 1)
  - [ ] Criar rota `/logout` no Remix com action para destruir a sessão
  - [ ] Implementar funcionalidade no `sessionService` para destruir sessões
  - [ ] Adicionar redirecionamento para `/login` após logout bem-sucedido
- [ ] Task 2 (AC: 2, 3)
  - [ ] Implementar middleware de autenticação reutilizável para rotas protegidas
  - [ ] Aplicar proteção a todas as rotas exceto `/login` e `/setup`
  - [ ] Adicionar redirecionamento para `/login` quando não autenticado
- [ ] Task 3: UI Components
  - [ ] Adicionar botão/link de "Logout" na interface principal
  - [ ] Integrar componente de logout com a ação da rota
- [ ] Task 4: Testing
  - [ ] Adicionar testes unitários para funcionalidade de logout no `sessionService`
  - [ ] Criar testes de integração para a rota `/logout`
  - [ ] Testar middleware de proteção em rotas diversas
  - [ ] Testar redirecionamentos corretos baseados no status de autenticação

## Dev Notes

### Previous Story Insights

- `AuthService` já implementado com métodos `hasUsers()`, `createFirstUser()`, e `validateLogin()` [Source: Previous Stories 2.1, 2.2]
- `SessionService` já criado para gerenciamento de sessões com cookie storage seguro [Source: Previous Story 2.1]
- Padrão de loader/action estabelecido para autenticação [Source: Previous Stories 2.1, 2.2]
- Redirecionamento baseado em status de autenticação já implementado na rota raiz [Source: Previous Story 2.1]

### Data Models

- **User Model**: Interface definida como `{ id: string; email: string; createdAt: Date; updatedAt: Date }` [Source: architecture/data-models-revised.md]
- **UserPublic**: Interface separada para uso no cliente, excluindo dados sensíveis [Source: Previous Story 2.2]
- **Shared Types**: Interfaces em `packages/shared-types` conforme padrão estabelecido [Source: architecture/coding-standards.md]

### API Specifications

- **Authentication Actions**: action para `/setup`, `/login`, `/logout` conforme definido [Source: architecture/api-specification.md]
- **Loaders e Actions**: Usar padrão Remix para `loader`(leitura) e `action`(escrita) [Source: architecture/api-specification.md]
- **Authentication Endpoints**: Seguir padrão estabelecido para autenticação [Source: Previous Stories 2.1, 2.2]

### Component Specifications

- **UI Components**: Usar shadcn/ui para componentes acessíveis e customizáveis [Source: architecture/tech-stack.md]
- **Styling**: Tailwind CSS 4.1.11 para estilização [Source: architecture/tech-stack.md]
- **Icons**: Lucide Icons para ícones [Source: architecture/tech-stack.md]
- **Logout UI**: Manter consistência com componentes existentes (LoginForm, SetupForm) [Source: Previous Stories 2.1, 2.2]

### File Locations

- **Services**: Lógica de negócio em `apps/web/app/services/` [Source: architecture/coding-standards.md]
- **Routes**: Rotas, Loaders, Actions em `apps/web/app/routes/` [Source: architecture/source-tree.md]
- **Components**: Componentes React em `apps/web/app/components/` [Source: architecture/source-tree.md]
- **Shared Types**: Interfaces TypeScript em `packages/shared-types/` [Source: architecture/source-tree.md]
- **Existing Services**: `authService` e `sessionService` já disponíveis em `apps/web/app/services/` [Source: Previous Stories 2.1, 2.2]

### Testing Requirements

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para testes isolados de services, componentes e funções utilitárias [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para testar fluxo completo de Remix routes (loader/action -> service -> test database) [Source: architecture/test-strategy.md]
- **Coverage**: Apontar para >80% de cobertura na lógica de negócio crítica [Source: architecture/test-strategy.md]
- **Test Data Management**: Usar Prisma seed script para popular test database, garantindo testes consistentes [Source: architecture/test-strategy.md]

### Technical Constraints

- **Language/Runtime**: TypeScript 5.8, Node.js 22.x [Source: architecture/coding-standards.md]
- **Framework**: Remix 2.16.8 para UI e lógica de servidor [Source: architecture/tech-stack.md]
- **Database**: SQLite ~5.x com Prisma 6.x [Source: architecture/tech-stack.md]
- **Environment Variables**: Acesso apenas através de módulo de config central tipado [Source: architecture/coding-standards.md]
- **Service Layer**: Toda lógica de negócio backend deve estar em `apps/web/app/services/` [Source: architecture/coding-standards.md]
- **Error Handling**: Usar classes de erro customizadas ao lançar exceções em services [Source: architecture/coding-standards.md]
- **Session Security**: Continuar usando padrão seguro de sessões estabelecido [Source: Previous Stories 2.1, 2.2]

### Project Structure Notes

A estrutura do projeto alinha com os requisitos da história:
- Rota `/logout` será criada em `apps/web/app/routes/` conforme source-tree.md
- `SessionService` existente será estendido para funcionalidade de logout [Source: Previous Stories 2.1, 2.2]
- Middleware de proteção será aplicado usando padrões Remix loader [Source: architecture/api-specification.md]
- Componentes de UI para logout em `apps/web/app/components/` conforme source-tree.md

### Testing

- **Test Files**: Usar convenção `*.test.tsx` ou `*.test.ts` [Source: architecture/coding-standards.md]
- **Unit Tests (Vitest)**: Para testes isolados de services, componentes e funções utilitárias [Source: architecture/test-strategy.md]
- **Integration Tests (Vitest)**: Para testar fluxo completo de Remix routes (loader/action -> service -> test database) [Source: architecture/test-strategy.md]
- **Coverage**: Apontar para >80% de cobertura na lógica de negócio crítica [Source: architecture/test-strategy.md]
- **Authentication Testing**: Seguir padrões estabelecidos nas histórias anteriores para testes de autenticação [Source: Previous Stories 2.1, 2.2]

## Change Log

| Date       | Version | Description   | Author             |
| ---------- | ------- | ------------- | ------------------ |
| 2025-07-22 | 1.0     | Initial draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes List

_To be filled by Dev Agent during implementation_

### File List

_To be filled by Dev Agent during implementation_

## QA Results

_To be filled by QA Agent after implementation review_