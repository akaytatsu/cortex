# Story 4.3: Backend - Carregador de Configuração de Agentes por Workspace

**Status**: Approved

## Dependencies
- **História 4.1**: Backend - Base da Comunicação com WebSocket (WebSocketManager necessário para notificar sessões sobre mudanças de agentes)
- **História 4.2**: Backend - Gerenciamento do Ciclo de Vida de Processos (ProcessService utilizará AgentService para executar comandos de agentes)
- **AuthService**: Sistema de autenticação existente para validar permissões de acesso
- **WorkspaceService**: Para validar existência e permissões de workspace
- **FileSystemService**: Para operações seguras de leitura de arquivos

## Story
**As a** Desenvolvedor(a),
**I want** que o backend leia um arquivo de configuração `.claude-agents.yaml` na raiz de um workspace,
**so that** agentes personalizados possam ser definidos dinamicamente para cada projeto.

## Acceptance Criteria
1. Ao receber uma solicitação, o backend procura por um arquivo `.claude-agents.yaml` no diretório do workspace especificado.
2. O backend consegue analisar o arquivo YAML, validando sua estrutura (uma lista de agentes com `name`, `description`, e `command`).
3. Um novo endpoint de API é criado (ex: `GET /api/workspaces/{ws_id}/agents`) que retorna a lista de agentes configurados ou uma lista vazia se o arquivo não existir.
4. Erros de análise no YAML são tratados graciosamente (ex: retornando uma lista vazia e logando o erro).
5. Configurações de agentes são cacheadas em memória com TTL de 5 minutos, invalidadas quando o arquivo é modificado.
6. Comandos de agentes são validados contra whitelist de comandos permitidos antes de serem aceitos.
7. Integração com ProcessService permite executar agentes carregados através de seus comandos.
8. Apenas usuários com permissão `workspace:read` podem acessar configurações de agentes.

## Tasks / Subtasks
- [ ] **Task 1: Criar Serviço de Agentes** (AC: 1, 2, 4, 5, 6, 7)
    - [ ] Subtask 1.1: Criar o arquivo `apps/web/app/services/agent.service.ts` [Source: architecture/coding-standards.md#14, architecture/source-tree.md#6-15]
    - [ ] Subtask 1.2: Definir interface `IAgentService` em `apps/web/app/types/services.ts` [Source: architecture/coding-standards.md#13]
    - [ ] Subtask 1.3: Criar interface `ClaudeAgent` em `packages/shared-types/index.ts` com campos `name`, `description`, e `command`
    - [ ] Subtask 1.3a: Criar interface `AgentCacheEntry` com campos `agents: ClaudeAgent[]`, `lastModified: Date`, `filePath: string`
    - [ ] Subtask 1.4: Implementar método `loadAgentsFromWorkspace(workspacePath: string)` que lê e processa o arquivo `.claude-agents.yaml`
    - [ ] Subtask 1.5: Implementar validação de path segura para prevenir directory traversal (rejeitar paths com `..`)
    - [ ] Subtask 1.6: Utilizar `FileSystemService` existente para operações de arquivo [Source: architecture/coding-standards.md#16]
    - [ ] Subtask 1.7: Implementar parsing YAML usando biblioteca `yaml` existente [Source: architecture/tech-stack.md#10]
    - [ ] Subtask 1.8: Criar classe `AgentServiceError extends Error` para erros específicos [Source: architecture/coding-standards.md#17]
    - [ ] Subtask 1.9: Implementar validação de estrutura YAML (verificar se é array, se cada item tem name/description/command)
    - [ ] Subtask 1.10: Configurar logger estruturado usando `createServiceLogger` [Source: architecture/error-handling-strategy.md#6]
    - [ ] Subtask 1.11: Implementar cache LRU para armazenar configurações com TTL de 5 minutos
    - [ ] Subtask 1.12: Implementar método `validateAgentCommand(command: string): boolean` para validar comandos contra whitelist
    - [ ] Subtask 1.13: Implementar método `invalidateCache(workspacePath: string)` para limpar cache quando necessário
    - [ ] Subtask 1.14: Criar método `getAgentByName(workspacePath: string, agentName: string)` para integração com ProcessService
- [ ] **Task 2: Criar Endpoint API REST** (AC: 3, 8)
    - [ ] Subtask 2.1: Criar arquivo `apps/web/app/routes/api.agents.$workspace.ts` [Source: architecture/api-specification.md#6-11]
    - [ ] Subtask 2.2: Implementar loader GET que usa `AgentService` para retornar agentes
    - [ ] Subtask 2.3: Implementar tratamento de erros com try/catch retornando JSON apropriado [Source: architecture/error-handling-strategy.md#4]
    - [ ] Subtask 2.4: Validar que o workspace existe e usuário tem permissão antes de buscar agentes
    - [ ] Subtask 2.5: Retornar resposta tipada usando interface `AgentListResponse`
    - [ ] Subtask 2.6: Incluir metadados na resposta (cacheTimestamp, fileLastModified, version)
    - [ ] Subtask 2.7: Implementar rate limiting para prevenir abuso do endpoint
    - [ ] Subtask 2.8: Adicionar métricas de performance para monitorar tempo de carregamento
- [ ] **Task 3: Implementar Tratamento de Erros** (AC: 4)
    - [ ] Subtask 3.1: Capturar erros de parsing YAML e logar detalhes usando logger estruturado
    - [ ] Subtask 3.2: Retornar array vazio em caso de erro, não expor detalhes do erro ao cliente [Source: architecture/error-handling-strategy.md#3]
    - [ ] Subtask 3.3: Logar diferentes tipos de erro (arquivo não encontrado, YAML inválido, estrutura incorreta) com níveis apropriados
    - [ ] Subtask 3.4: Implementar retry lógica simples para erros de leitura de arquivo transitórios
    - [ ] Subtask 3.5: Retornar estrutura de erro padronizada com código, mensagem e contexto
    - [ ] Subtask 3.6: Implementar notificação via WebSocket quando configuração de agentes falha ao carregar
- [ ] **Task 4: Adicionar Testes** 
    - [ ] Subtask 4.1: Criar `apps/web/app/services/agent.service.test.ts` [Source: architecture/test-strategy.md#11, architecture/coding-standards.md#9]
    - [ ] Subtask 4.2: Escrever testes unitários para parsing de YAML válido
    - [ ] Subtask 4.3: Escrever testes para cenários de erro (arquivo não existe, YAML inválido, estrutura incorreta)
    - [ ] Subtask 4.4: Escrever testes para validação de segurança (paths com `..`)
    - [ ] Subtask 4.5: Mockar FileSystemService nos testes unitários
    - [ ] Subtask 4.6: Criar teste de integração para endpoint API verificando resposta completa
    - [ ] Subtask 4.7: Garantir cobertura >80% do código crítico [Source: architecture/test-strategy.md#7]
    - [ ] Subtask 4.8: Escrever testes para funcionalidade de cache (hit/miss/invalidation)
    - [ ] Subtask 4.9: Escrever testes para validação de comandos contra whitelist
    - [ ] Subtask 4.10: Escrever testes de integração com ProcessService mock

## Dev Notes

### Stack Tecnológica
- **Runtime**: Node.js 22.x com TypeScript 5.8 [Source: architecture/tech-stack.md#7-8]
- **Framework**: Remix 2.16.8 para endpoints via loaders/actions [Source: architecture/tech-stack.md#9]
- **Biblioteca YAML**: `yaml` (já instalada no projeto) [Source: architecture/tech-stack.md#10]
- **Testing**: Vitest para testes unitários e de integração [Source: architecture/test-strategy.md#11]

### Estrutura de Código

**Localização dos Arquivos:**
```
apps/web/app/
├── services/
│   ├── agent.service.ts         # Serviço principal para carregar agentes
│   └── agent.service.test.ts    # Testes unitários
├── routes/
│   └── api.agents.$workspace.ts # Endpoint REST
└── types/
    └── services.ts             # Interface IAgentService

packages/shared-types/
└── index.ts                    # Interface ClaudeAgent
```
[Source: architecture/source-tree.md#6-15]

### Padrões de Implementação

**Estrutura da Interface ClaudeAgent:**
```typescript
interface ClaudeAgent {
  name: string;
  description: string;
  command: string;
}

interface AgentCacheEntry {
  agents: ClaudeAgent[];
  lastModified: Date;
  filePath: string;
  ttl: number;
}

interface AgentListResponse {
  agents: ClaudeAgent[];
  metadata: {
    cacheTimestamp: string;
    fileLastModified: string;
    version: string;
    fromCache: boolean;
  };
}
```

**Estrutura esperada do arquivo .claude-agents.yaml:**
```yaml
- name: "test-runner"
  description: "Executa testes automatizados"
  command: "claude test"
  
- name: "code-reviewer"
  description: "Revisa código e sugere melhorias"
  command: "claude review"
```

**Padrão de Resposta da API:**
- Sucesso: `200 OK` com `AgentListResponse` contendo agentes e metadados
- Arquivo não existe: `200 OK` com `AgentListResponse` com array vazio e metadata.fromCache=false
- Erro de parsing: `200 OK` com `AgentListResponse` vazio + erro logado internamente
- Workspace não existe: `404 Not Found` com `{ error: { code: 'WORKSPACE_NOT_FOUND', message: '...', context: {...} } }`
- Sem permissão: `403 Forbidden` com `{ error: { code: 'PERMISSION_DENIED', message: '...', requiredPermission: 'workspace:read' } }`
- Rate limit excedido: `429 Too Many Requests` com headers Retry-After

### Requisitos de Segurança
- Validar todos os caminhos de workspace para prevenir directory traversal
- Não expor detalhes de erros internos ao cliente
- Verificar permissões do usuário antes de acessar arquivos do workspace (permissão `workspace:read` necessária)
- Logar todas as tentativas de acesso suspeitas
- Validar comandos de agentes contra whitelist:
  ```typescript
  const ALLOWED_COMMAND_PREFIXES = [
    'claude code',
    'claude test',
    'claude review',
    'claude analyze',
    'claude help'
  ];
  ```
- Implementar rate limiting: máximo 30 requisições por minuto por workspace

### Integração com Serviços Existentes
- Usar `FileSystemService` para todas operações de arquivo [Source: architecture/coding-standards.md#16]
- Seguir padrão de error handling com classes customizadas [Source: architecture/coding-standards.md#17]
- Usar `createServiceLogger` para logging estruturado [Source: architecture/error-handling-strategy.md#6]
- Integrar com sistema de permissões existente do WorkspaceService
- **Integração com ProcessService (História 4.2)**:
  ```typescript
  // ProcessService utilizará AgentService
  const agent = await agentService.getAgentByName(workspacePath, agentName);
  if (agent && agentService.validateAgentCommand(agent.command)) {
    await processService.executeCommand(agent.command, sessionId);
  }
  ```
- **Integração com WebSocketManager (História 4.1)**:
  ```typescript
  // Notificar sessões sobre mudanças de agentes
  await webSocketManager.broadcast(workspaceId, {
    type: 'agents-updated',
    agents: updatedAgents
  });
  ```
- **Integração com AuthService**:
  ```typescript
  // Verificar permissões antes de acessar agentes
  const hasPermission = await authService.checkPermission(userId, 'workspace:read', workspaceId);
  ```

### Testing
**Estratégia de Testes:**
- **Framework**: Vitest para todos os testes [Source: architecture/test-strategy.md#11]
- **Localização**: Testes ao lado dos arquivos de implementação com sufixo `.test.ts` [Source: architecture/coding-standards.md#9]
- **Cobertura**: Mínimo 80% para lógica crítica de negócio [Source: architecture/test-strategy.md#7]
- **Tipos de Teste**:
  - Unitários: Testar parsing YAML, validação de estrutura, tratamento de erros
  - Integração: Testar endpoint completo com diferentes cenários
- **Mocking**: Mockar FileSystemService para isolar testes unitários
- **Casos de Teste Críticos**:
  - YAML válido com múltiplos agentes
  - YAML vazio ou arquivo não existente
  - YAML com estrutura inválida
  - Tentativas de directory traversal
  - Permissões de workspace
  - Cache hit/miss scenarios
  - Validação de comandos maliciosos
  - Rate limiting behavior

### Estratégia de Cache
- **Implementação**: Cache LRU em memória com capacidade máxima de 100 workspaces
- **TTL**: 5 minutos por entrada
- **Invalidação**:
  - Automática após TTL expirar
  - Manual via método `invalidateCache(workspacePath)`
  - Quando arquivo `.claude-agents.yaml` é modificado (detectado via file watcher)
- **Métricas de Cache**:
  - Hit rate
  - Miss rate
  - Tempo médio de carregamento (com/sem cache)

### Monitoramento e Métricas
- **Performance**:
  - Tempo de carregamento de configurações
  - Taxa de cache hit/miss
  - Tempo de parsing YAML
- **Uso**:
  - Agentes mais utilizados por workspace
  - Frequência de recarregamento de configurações
  - Erros de validação mais comuns
- **Segurança**:
  - Tentativas de acesso negadas
  - Comandos rejeitados por validação
  - Rate limit violations

## Change Log
| Data | Versão | Descrição | Autor |
|---|---|---|---|
| 2025-07-23 | 1.0 | Criação inicial da história | Bob (sm) |
| 2025-07-23 | 1.1 | Adicionadas dependências, integração com serviços, cache, segurança e métricas | Sarah (po) |
| 2025-07-23 | 1.2 | Story aprovada após validação completa - pontuação 100/100 - pronta para implementação | Sarah (po) |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results
_TBD_