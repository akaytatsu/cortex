# História 3.10: Remover Prisma e Implementar Autenticação YAML

**Status**: Draft  
**Epic**: 3 - Simplificação da Arquitetura  
**Story**: 3.10  
**Título**: Remove Prisma Database and Implement YAML-based Authentication  
**Estimativa**: 13 pontos  

## Story

**As a** desenvolvedor/administrador do sistema,  
**I want** remover completamente o Prisma ORM e o banco de dados SQLite, substituindo por autenticação baseada em arquivo YAML com senhas criptografadas,  
**so that** o sistema seja mais simples de configurar, manter e implantar, sem dependências de banco de dados.

## Acceptance Criteria

1. **Remoção Completa do Prisma**
   - [ ] Remover todas as dependências do Prisma (`@prisma/client`, `prisma`, `sqlite3`)
   - [ ] Excluir pasta `prisma/` e arquivo `schema.prisma`
   - [ ] Remover arquivo de banco SQLite (`dev.db`)
   - [ ] Excluir todas as migrações do Prisma

2. **Implementação do Sistema YAML**
   - [ ] Criar arquivo de configuração `apps/web/config/users.yaml` com estrutura apropriada
   - [ ] Adicionar `config/users.yaml` ao `.gitignore` para segurança
   - [ ] Implementar validação de schema para o arquivo YAML
   - [ ] Definir formato estruturado para usuários (id, email, password_hash, role, created_at, updated_at)

3. **Criptografia de Senhas**
   - [ ] Manter bcryptjs para hash de senhas
   - [ ] Implementar salt rounds configurável (mínimo 12)
   - [ ] Adicionar validação de força de senha
   - [ ] Implementar rotação de hashes (rehashing em login se necessário)

4. **Novo AuthService YAML-based**
   - [ ] Refatorar `AuthService` para ler do arquivo YAML
   - [ ] Implementar cache em memória para performance
   - [ ] Adicionar file watching para reload automático
   - [ ] Manter compatibilidade com interface existente

5. **Novo UserService YAML-based**
   - [ ] Refatorar `UserService` para operações CRUD no YAML
   - [ ] Implementar locking para writes concorrentes
   - [ ] Adicionar backup automático antes de modificações
   - [ ] Implementar validação de integridade de dados

6. **Segurança e Práticas**
   - [ ] Implementar permissões de arquivo restritivas (600)
   - [ ] Adicionar validação de formato de email
   - [ ] Implementar rate limiting para tentativas de login
   - [ ] Adicionar logs de auditoria para operações de usuário

7. **Migração de Dados**
   - [ ] Criar script de migração dos dados existentes do SQLite para YAML
   - [ ] Implementar backup dos dados antes da migração
   - [ ] Validar integridade dos dados migrados

8. **Configuração e Setup**
   - [ ] Atualizar processo de primeiro usuário para YAML
   - [ ] Modificar rota `/setup` para criar arquivo YAML inicial em `apps/web/config/`
   - [ ] Implementar validação de configuração no startup
   - [ ] Adicionar documentação de configuração
   - [ ] Adicionar `config/users.yaml` ao `.gitignore`

9. **Testes e Qualidade**
   - [ ] Adaptar todos os testes para nova implementação
   - [ ] Adicionar testes de performance para operações de arquivo
   - [ ] Implementar testes de concurrent access
   - [ ] Validar compatibilidade com fluxo de autenticação existente

10. **Documentação e Deploy**
    - [ ] Atualizar README com nova configuração
    - [ ] Documentar estrutura do arquivo YAML
    - [ ] Atualizar scripts de deploy
    - [ ] Criar guia de migração para usuários existentes

## Tasks / Subtasks

### Fase 1: Preparação e Setup (AC 1, 2)
- [ ] **Task 1.1**: Análise detalhada de dependências do Prisma (AC 1)
- [ ] **Task 1.2**: Design da estrutura do arquivo YAML (AC 2)
- [ ] **Task 1.3**: Criação do schema de validação YAML (AC 2)

### Fase 2: Implementação Core (AC 4, 5, 6)
- [ ] **Task 2.1**: Refatoração do AuthService para YAML (AC 4)
- [ ] **Task 2.2**: Refatoração do UserService para YAML (AC 5)
- [ ] **Task 2.3**: Implementação de file watching e cache (AC 4)
- [ ] **Task 2.4**: Implementação de locking e backup (AC 5)
- [ ] **Task 2.5**: Implementação de práticas de segurança (AC 6)

### Fase 3: Migração e Setup (AC 7, 8)
- [ ] **Task 3.1**: Desenvolvimento do script de migração (AC 7)
- [ ] **Task 3.2**: Atualização do processo de setup inicial (AC 8)
- [ ] **Task 3.3**: Configuração de permissões e validações (AC 8)

### Fase 4: Remoção e Limpeza (AC 1)
- [ ] **Task 4.1**: Remoção completa do Prisma e dependências (AC 1)
- [ ] **Task 4.2**: Limpeza de arquivos e migrações (AC 1)

### Fase 5: Testes e Documentação (AC 9, 10)
- [ ] **Task 5.1**: Adaptação e criação de testes (AC 9)
- [ ] **Task 5.2**: Atualização da documentação (AC 10)
- [ ] **Task 5.3**: Criação de guias de migração (AC 10)

## Dev Notes

### Implementação Técnica

**Estrutura do Arquivo YAML:**
```yaml
# apps/web/config/users.yaml
users:
  - id: "user_01ABCDEF123456789"
    email: "admin@domain.com"
    password_hash: "$2b$12$..."
    role: "admin"
    created_at: "2025-01-15T10:30:00Z"
    updated_at: "2025-01-15T10:30:00Z"
    last_login: "2025-01-20T14:22:00Z"
    active: true
```

**Considerações de Performance:**
- Implementar cache em memória com TTL configurável
- File watching usando `fs.watchFile()` ou `chokidar`
- Lazy loading do arquivo YAML apenas quando necessário
- Debounce para reloads frequentes

**Segurança:**
- Arquivo YAML deve ter permissões 600 (rw--------)
- Validar formato de email usando biblioteca robusta
- Rate limiting usando middleware personalizado
- Logs de auditoria em arquivo separado com rotação

**Backup e Recovery:**
- Backup automático antes de cada write operation
- Manter últimas N versões do arquivo
- Validação de integridade usando checksums
- Recovery automático em caso de corrupção

### Testing Standards

- **Unit Tests**: Cobertura de 90%+ para novos serviços
- **Integration Tests**: Testes de file operations e concurrency
- **Performance Tests**: Benchmarks para operações de read/write
- **Security Tests**: Validação de permissões e rate limiting

### Dependências Afetadas

**Remover:**
- `@prisma/client`
- `prisma`
- `sqlite3`

**Adicionar:**
- `yaml` (para parsing)
- `joi` ou `zod` (para validação de schema)
- `file-lock` (para operações concorrentes)

### Arquivos Principais Afetados

- `app/services/auth.service.ts`
- `app/services/user.service.ts`
- `app/lib/prisma.ts` (remover)
- `app/routes/setup.tsx`
- `app/routes/login.tsx`
- `package.json`

## Change Log

| Data | Versão | Descrição | Autor |
|------|--------|-----------|--------|
| 2025-01-23 | 1.0 | Criação inicial da história | Sarah (PO) |

## Dev Agent Record

*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação.*

## QA Results

*Esta seção será preenchida pelo agente de QA durante a revisão.*