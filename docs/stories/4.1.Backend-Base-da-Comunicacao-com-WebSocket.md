# Story 4.1: Backend - Base da Comunicação com WebSocket

**Status**: Draft
**Epic**: 4 - O Copiloto Inteligente com Agentes Dinâmicos
**Story**: 4.1
**Título**: Backend - Base da Comunicação com WebSocket
**Estimativa**: 8 pontos

## Story

**As a** Desenvolvedor(a),
**I want** um servidor WebSocket robusto,
**so that** o frontend e o backend possam ter um canal de comunicação persistente e em tempo real para todas as interações com o `claude code`.

## Acceptance Criteria

1. Um servidor WebSocket é implementado e executado junto com a aplicação web principal.
2. O servidor gerencia múltiplas conexões de clientes concorrentes, mapeando cada conexão a um usuário autenticado.
3. Um protocolo claro para mensagens (ex: `iniciar_sessao`, `enviar_comando`, `receber_output`, `sessao_encerrada`) é definido e documentado.

## Tasks / Subtasks

- [ ] **Task 1: Configuração Inicial do Servidor WebSocket** (AC: 1)
    - [ ] Subtask 1.1: Adicionar a dependência `ws` ao `package.json`.
    - [ ] Subtask 1.2: Criar um novo módulo em `apps/web/app/lib/websocket-server.ts` para encapsular a lógica do servidor WebSocket. [Source: docs/architecture/source-tree.md]
    - [ ] Subtask 1.3: Iniciar o servidor WebSocket junto com a aplicação Remix.

- [ ] **Task 2: Gerenciamento de Conexões e Autenticação** (AC: 2)
    - [ ] Subtask 2.1: Implementar a lógica para lidar com novas conexões WebSocket.
    - [ ] Subtask 2.2: Integrar com o `SessionService` para autenticar o usuário de cada conexão.
    - [ ] Subtask 2.3: Manter um mapa das conexões ativas, associando cada `WebSocket` a um `userId`.

- [ ] **Task 3: Definição e Implementação do Protocolo de Mensagens** (AC: 3)
    - [ ] Subtask 3.1: Definir as interfaces TypeScript para as mensagens WebSocket em `packages/shared-types`. [Source: docs/architecture/coding-standards.md]
    - [ ] Subtask 3.2: Implementar a lógica de tratamento de mensagens no servidor para receber e processar mensagens do cliente.
    - [ ] Subtask 3.3: Implementar a lógica para enviar mensagens do servidor para clientes específicos.

- [ ] **Task 4: Testes**
    - [ ] Subtask 4.1: Escrever testes de unidade para a lógica de autenticação do WebSocket. [Source: docs/architecture/test-strategy.md]
    - [ ] Subtask 4.2: Escrever testes de integração para o fluxo de conexão e troca de mensagens. [Source: docs/architecture/test-strategy.md]

## Dev Notes

### Requisitos Técnicos
- **Tecnologia:** `ws` (Node.js WebSocket library) [Source: docs/architecture/tech-stack.md]
- **Localização do Código:** `apps/web/app/lib/websocket-server.ts` [Source: docs/architecture/source-tree.md]
- **Padrões de Código:** Seguir os padrões definidos em `docs/architecture/coding-standards.md`.

### Protocolo de Mensagens
A definição das mensagens deve ser criada em `packages/shared-types` para ser compartilhada entre o frontend e o backend.

```typescript
// packages/shared-types/index.ts
export interface WebSocketMessage {
  type: 'iniciar_sessao' | 'enviar_comando' | 'receber_output' | 'sessao_encerrada';
  payload: any;
}
```
[Source: docs/architecture/api-specification.md]

### Autenticação
A autenticação de cada conexão WebSocket deve ser feita utilizando o `SessionService` existente para validar a sessão do usuário. Conexões não autenticadas devem ser rejeitadas.

### Testes
- Os testes devem seguir a estratégia definida em `docs/architecture/test-strategy.md`.
- Criar testes de unidade para as funções de manipulação de mensagens e autenticação.
- Criar testes de integração que simulem um cliente WebSocket conectando, autenticando e trocando mensagens.

## Change Log

| Data | Versão | Descrição | Autor |
|------|--------|-----------|-------|
| 2025-07-23 | 1.0 | Criação inicial da história | Bob (sm) |
