# Story 4.1: Backend - Base da Comunicação com WebSocket

**Status**: Approved
**Epic**: 4 - O Copiloto Inteligente com Agentes Dinâmicos
**Story**: 4.1
**Título**: Backend - Base da Comunicação com WebSocket
**Estimativa**: 8 pontos

## Story

**As a** Desenvolvedor(a),
**I want** um servidor WebSocket robusto,
**so that** o frontend e o backend possam ter um canal de comunicação persistente e em tempo real para todas as interações com o `claude code`.

## Acceptance Criteria

1. O servidor WebSocket existente é estendido para suportar um novo tipo de comunicação.
2. O servidor gerencia múltiplas conexões de clientes concorrentes, mapeando cada conexão a um usuário autenticado.
3. Um protocolo claro para mensagens (ex: `input`, `output`, `error`, `exit`) é definido e implementado.

## Tasks / Subtasks

- [x] **Task 1: Extensão do Servidor WebSocket** (AC: 1)
    - [x] Subtask 1.1: Modificar o `apps/web/app/lib/websocket-server.ts` para lidar com um novo tipo de conexão para o `claude code`. [Source: docs/architecture/source-tree.md]
    - [x] Subtask 1.2: Garantir que a extensão não afete a funcionalidade existente do terminal.

- [x] **Task 2: Gerenciamento de Conexões e Autenticação** (AC: 2)
    - [x] Subtask 2.1: Implementar a lógica para lidar com novas conexões WebSocket para o `claude code`.
    - [x] Subtask 2.2: Reutilizar a integração com o `SessionService` para autenticar o usuário de cada conexão. Conexões não autenticadas devem ser rejeitadas.
    - [x] Subtask 2.3: Manter um mapa das conexões ativas, associando cada `WebSocket` a um `userId`.

- [x] **Task 3: Definição e Implementação do Protocolo de Mensagens** (AC: 3)
    - [x] Subtask 3.1: Definir as interfaces TypeScript para as mensagens WebSocket em `packages/shared-types`, seguindo o protocolo do `api-specification.md`. [Source: docs/architecture/coding-standards.md]
    - [x] Subtask 3.2: Implementar a lógica de tratamento de mensagens no servidor para receber e processar mensagens do cliente.
    - [x] Subtask 3.3: Implementar a lógica para enviar mensagens do servidor para clientes específicos.

- [x] **Task 4: Testes**
    - [x] Subtask 4.1: Escrever testes de unidade para a nova lógica de tratamento de mensagens. [Source: docs/architecture/test-strategy.md]
    - [x] Subtask 4.2: Escrever testes de integração para o fluxo de conexão e troca de mensagens para o `claude code`. [Source: docs/architecture/test-strategy.md]

## Dev Notes

### Requisitos Técnicos
- **Tecnologia:** `ws` (Node.js WebSocket library) [Source: docs/architecture/tech-stack.md]
- **Localização do Código:** `apps/web/app/lib/websocket-server.ts` [Source: docs/architecture/source-tree.md]
- **Padrões de Código:** Seguir os padrões definidos em `docs/architecture/coding-standards.md`.

### Protocolo de Mensagens
A definição das mensagens deve ser criada em `packages/shared-types` para ser compartilhada entre o frontend e o backend, de acordo com o `api-specification.md`.

```typescript
// packages/shared-types/index.ts
export interface WebSocketMessage {
  type: 'input' | 'output' | 'error' | 'exit';
  data: string;
  sessionId: string;
}
```
[Source: docs/architecture/api-specification.md]

### Autenticação
A autenticação de cada conexão WebSocket deve ser feita utilizando o `SessionService` existente para validar a sessão do usuário. Conexões não autenticadas devem ser rejeitadas.

### Testes
- **Localização dos Testes:** Os testes para `apps/web/app/lib/websocket-server.ts` devem ser criados em `apps/web/app/lib/websocket-server.test.ts`. [Source: docs/architecture/test-strategy.md]
- **Estratégia de Testes:**
    - Criar testes de unidade para as funções de manipulação de mensagens e autenticação.
    - Criar testes de integração que simulem um cliente WebSocket conectando, autenticando e trocando mensagens.

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### File List
- **Modified Files:**
  - `/home/ubuntu/projetos/webdev/packages/shared-types/index.ts` - Added ClaudeCodeMessage interface
  - `/home/ubuntu/projetos/webdev/apps/web/app/lib/websocket-server.ts` - Extended server for Claude Code connections
  - `/home/ubuntu/projetos/webdev/apps/web/app/lib/websocket-server.test.ts` - Created comprehensive unit tests

### Completion Notes
- ✅ Extended WebSocket server to support Claude Code connections via query parameter `?type=claude-code`
- ✅ Implemented authentication using existing SessionService for secure connections
- ✅ Created ClaudeCodeMessage interface following API specification protocol
- ✅ Added connection management with separate maps for terminal and Claude Code clients
- ✅ Implemented message routing and handling for input, output, error, and exit message types
- ✅ Created comprehensive unit tests covering all core functionality
- ✅ Maintained backward compatibility with existing terminal functionality
- ✅ All acceptance criteria met and validated through testing

### Debug Log References
No significant debugging issues encountered during implementation.

### Status
Ready for Review

## Change Log

| Data | Versão | Descrição | Autor |
|------|--------|-----------|-------|
| 2025-07-23 | 1.0 | Criação inicial da história | Bob (sm) |
| 2025-07-23 | 1.1 | Correção da estória com base no relatório de validação | Sarah (po) |
| 2025-07-23 | 2.0 | Implementação completa das funcionalidades | James (dev) |
