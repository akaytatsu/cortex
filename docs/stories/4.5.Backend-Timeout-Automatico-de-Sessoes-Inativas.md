# Story 4.5: Backend - Timeout Autom√°tico de Sess√µes Inativas

**Status**: Done

## Story
**As a** Desenvolvedor(a),
**I want** que sess√µes inativas por mais de 12 horas sejam encerradas,
**so that** os recursos do sistema sejam preservados.

## Acceptance Criteria
1. Uma tarefa agendada verifica periodicamente o `sessions.yaml`.
2. Sess√µes com mais de 12 horas de dura√ß√£o s√£o identificadas.
3. O processo `claude code` correspondente √© encerrado, e a entrada √© removida do `sessions.yaml`.

## Tasks / Subtasks
- [x] **Task 1: Criar SessionTimeoutService** (AC: 1, 2, 3)
  - [x] Subtask 1.1: Criar arquivo `apps/web/app/services/session-timeout.service.ts` [Source: architecture/source-tree.md#14]
  - [x] Subtask 1.2: Definir interface `ISessionTimeoutService` em `apps/web/app/types/services.ts` [Source: architecture/coding-standards.md#13]
  - [x] Subtask 1.3: Implementar m√©todo `checkAndCleanupTimedOutSessions(): Promise<void>`
  - [x] Subtask 1.4: Configurar timeout de 12 horas (12 * 60 * 60 * 1000 ms) como constante
  - [x] Subtask 1.5: Integrar com SessionPersistenceService para carregar sess√µes ativas
  - [x] Subtask 1.6: Verificar tempo de vida da sess√£o comparando startedAt com hor√°rio atual
  - [x] Subtask 1.7: Para sess√µes expiradas, encerrar processo usando process.kill(pid, 'SIGTERM')
  - [x] Subtask 1.8: Para processos que n√£o respondem, usar SIGKILL ap√≥s timeout de graceful shutdown
  - [x] Subtask 1.9: Remover sess√µes expiradas do sessions.yaml via SessionPersistenceService
  - [x] Subtask 1.10: Configurar logger estruturado usando `createServiceLogger` [Source: architecture/error-handling-strategy.md#6]
  - [x] Subtask 1.11: Implementar tratamento de erros para processos j√° encerrados ou PIDs inv√°lidos

- [x] **Task 2: Implementar Agendamento Peri√≥dico de Limpeza** (AC: 1)
  - [x] Subtask 2.1: Criar m√©todo `startPeriodicCleanup(intervalMs?: number): NodeJS.Timeout`
  - [x] Subtask 2.2: Configurar intervalo padr√£o de verifica√ß√£o (30 minutos)
  - [x] Subtask 2.3: Implementar m√©todo `stopPeriodicCleanup()` para parar o agendamento
  - [x] Subtask 2.4: Adicionar logs informativos sobre in√≠cio e parada do agendamento
  - [x] Subtask 2.5: Garantir que apenas uma inst√¢ncia do timer est√° ativa (singleton pattern)
  - [x] Subtask 2.6: Tratar erros durante execu√ß√£o peri√≥dica sem parar o agendamento

- [x] **Task 3: Integrar SessionTimeoutService com Aplica√ß√£o Principal** (AC: 1, 2, 3)
  - [x] Subtask 3.1: Inicializar SessionTimeoutService no startup da aplica√ß√£o (main server file)
  - [x] Subtask 3.2: Iniciar limpeza peri√≥dica no boot da aplica√ß√£o
  - [x] Subtask 3.3: Configurar graceful shutdown para parar timers ao encerrar aplica√ß√£o
  - [x] Subtask 3.4: Adicionar logs de inicializa√ß√£o e shutdown do servi√ßo de timeout
  - [x] Subtask 3.5: Garantir que o servi√ßo seja iniciado apenas ap√≥s SessionPersistenceService estar dispon√≠vel

- [x] **Task 4: Adicionar Testes Unit√°rios** (AC: 1, 2, 3)
  - [x] Subtask 4.1: Criar arquivo `apps/web/app/services/session-timeout.service.test.ts` [Source: architecture/test-strategy.md#11]
  - [x] Subtask 4.2: Testar identifica√ß√£o de sess√µes expiradas (mais de 12 horas)
  - [x] Subtask 4.3: Testar que sess√µes recentes (menos de 12 horas) n√£o s√£o encerradas
  - [x] Subtask 4.4: Testar encerramento de processo com SIGTERM seguido de SIGKILL se necess√°rio
  - [x] Subtask 4.5: Testar remo√ß√£o de sess√µes expiradas do arquivo sessions.yaml
  - [x] Subtask 4.6: Testar comportamento com PIDs inv√°lidos ou processos j√° encerrados
  - [x] Subtask 4.7: Testar agendamento peri√≥dico (start/stop de timers)
  - [x] Subtask 4.8: Mockar SessionPersistenceService e process.kill para isolar testes [Source: architecture/test-strategy.md#12]
  - [x] Subtask 4.9: Testar graceful shutdown do servi√ßo
  - [x] Subtask 4.10: Testar tratamento de erros durante limpeza peri√≥dica

## Dev Notes

### Previous Story Insights
- **SessionPersistenceService** j√° implementado na hist√≥ria 4.4 com cache TTL e sistema de backup
- Sistema robusto de recupera√ß√£o de sess√µes com verifica√ß√£o de processos ativos usando process.kill(pid, 0)
- Interface PersistedSession com campos: id, workspaceName, workspacePath, pid, startedAt, agentName, command, userId, recovered
- Logs estruturados e tratamento de erros j√° estabelecidos no padr√£o do projeto

### Data Models
- **Interface PersistedSession** j√° existe em `packages/shared-types/index.ts` com campo `startedAt: string` (ISO date string)
- **Timeout Configuration**:
  ```typescript
  const SESSION_TIMEOUT_MS = 12 * 60 * 60 * 1000; // 12 hours
  const CLEANUP_INTERVAL_MS = 30 * 60 * 1000; // 30 minutes check interval
  const GRACEFUL_SHUTDOWN_TIMEOUT_MS = 5000; // 5 seconds for SIGTERM before SIGKILL
  ```

### API Specifications
- N√£o h√° endpoints REST nesta hist√≥ria, apenas servi√ßo interno de background

### Component Specifications
- N√£o h√° componentes UI nesta hist√≥ria

### File Locations
- **Novo servi√ßo**: `apps/web/app/services/session-timeout.service.ts`
- **Interface do servi√ßo**: Adicionar em `apps/web/app/types/services.ts`
- **Testes**: `apps/web/app/services/session-timeout.service.test.ts`
- **Integra√ß√£o**: Modificar arquivo principal de inicializa√ß√£o da aplica√ß√£o

### Testing Requirements
- Framework: Vitest [Source: architecture/test-strategy.md#11]
- Cobertura m√≠nima: 80% [Source: architecture/test-strategy.md#8]
- Mockar process.kill, setTimeout/clearTimeout e SessionPersistenceService [Source: architecture/test-strategy.md#12]
- Testar casos de erro e edge cases [Source: architecture/test-strategy.md#8]

### Technical Constraints
- Usar SessionPersistenceService existente para opera√ß√µes com sessions.yaml [Source: hist√≥ria 4.4]
- Seguir padr√£o de inje√ß√£o de depend√™ncias [Source: architecture/coding-standards.md#13]
- Implementar ILogger para logs estruturados [Source: architecture/error-handling-strategy.md#6]
- Timeout de 12 horas conforme especificado no √©pico
- Intervalo de verifica√ß√£o de 30 minutos para balancear performance e responsividade
- Graceful shutdown com SIGTERM seguido de SIGKILL se necess√°rio

### Security Considerations
- Validar PIDs antes de tentar encerrar processos
- Usar SIGTERM primeiro para permitir cleanup graceful do processo claude code
- N√£o logar informa√ß√µes sens√≠veis sobre usu√°rios ou workspaces em logs de erro
- Verificar permiss√µes antes de encerrar processos (apenas processos pr√≥prios)

### Integration Points
- **SessionPersistenceService**: Principal depend√™ncia para leitura/escrita de sessions.yaml
- **CliService**: Potencial integra√ß√£o futura para notificar sobre sess√µes encerradas
- **WebSocketManager**: Potencial integra√ß√£o para notificar clientes sobre sess√µes encerradas por timeout
- **Application Bootstrap**: Inicializa√ß√£o do servi√ßo no startup da aplica√ß√£o

### Performance Considerations
- Cache do SessionPersistenceService (5 min TTL) reduz I/O durante verifica√ß√µes peri√≥dicas
- Intervalo de 30 minutos balanceia responsividade vs overhead do sistema
- Graceful shutdown com timeout de 5 segundos evita processos zumbis
- Logs de debug apenas para desenvolvimento, logs info para produ√ß√£o

## Testing

### Test file location
- `apps/web/app/services/session-timeout.service.test.ts`

### Test standards
- Usar Vitest com describe/it blocks [Source: architecture/test-strategy.md#11]
- Mockar todas as depend√™ncias externas (SessionPersistenceService, process.kill, timers)
- Testar casos de sucesso e falha
- Verificar logs com mock de ILogger

### Testing frameworks and patterns to use
- Vitest para unit tests
- Mock de SessionPersistenceService para isolar l√≥gica de timeout
- Mock de process.kill para simular encerramento de processos
- Mock de setTimeout/clearTimeout para testar agendamento
- Usar beforeEach/afterEach para setup/cleanup de timers
- Fixtures para dados de teste de sess√µes com diferentes idades

### Specific testing requirements for this story
- Testar c√°lculo correto de idade da sess√£o (startedAt vs Date.now())
- Testar que sess√µes com menos de 12 horas s√£o mantidas
- Testar que sess√µes com mais de 12 horas s√£o encerradas
- Testar sequ√™ncia SIGTERM -> aguardar -> SIGKILL se necess√°rio
- Testar comportamento com PIDs inv√°lidos ou processos j√° mortos
- Testar que o timer peri√≥dico pode ser iniciado e parado corretamente
- Testar que erros durante limpeza n√£o param o agendamento
- Verificar que sessions.yaml √© atualizado ap√≥s limpeza de sess√µes expiradas

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-23 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-07-23 | 1.1 | Implementation completed | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
- **Claude Sonnet 4** (claude-sonnet-4-20250514)

### Debug Log References
- All implementation details logged during development
- Test execution results documented
- Service integration verified

### Completion Notes
- ‚úÖ **SessionTimeoutService criado** com todos os m√©todos necess√°rios para timeout de 12 horas
- ‚úÖ **Interface ISessionTimeoutService** definida em types/services.ts
- ‚úÖ **Agendamento peri√≥dico** implementado com intervalo padr√£o de 30 minutos
- ‚úÖ **Integra√ß√£o com aplica√ß√£o** atrav√©s do service-container e entry.server.tsx
- ‚úÖ **Graceful shutdown** configurado para parar timers ao encerrar aplica√ß√£o
- ‚úÖ **Testes unit√°rios** implementados com 11 testes passando, cobrindo cen√°rios principais
- ‚úÖ **Logs estruturados** implementados usando createServiceLogger
- ‚úÖ **Tratamento de erros** para PIDs inv√°lidos, processos inexistentes e erros de permiss√£o

### File List
- **apps/web/app/services/session-timeout.service.ts** - Novo servi√ßo principal
- **apps/web/app/services/session-timeout.service.test.ts** - Testes unit√°rios
- **apps/web/app/types/services.ts** - Interface ISessionTimeoutService adicionada
- **apps/web/app/lib/service-container.ts** - Servi√ßos registrados no container
- **apps/web/app/entry.server.tsx** - Inicializa√ß√£o e graceful shutdown configurados

**Status**: Ready for Review

## QA Results

**Reviewed by:** Quinn (Senior Developer & QA Architect) üß™
**Review Date:** 2025-07-23
**Review Status:** ‚úÖ **APROVADO**

### ‚úÖ Code Quality Assessment

**SessionTimeoutService (apps/web/app/services/session-timeout.service.ts:184)**
- **Arquitetura**: Excelente implementa√ß√£o seguindo padr√µes SOLID e inje√ß√£o de depend√™ncias
- **Configura√ß√£o**: Constantes bem definidas (12h timeout, 30min intervalo, 5s graceful shutdown)
- **Tratamento de Processos**: Implementa√ß√£o robusta com SIGTERM ‚Üí SIGKILL fallback
- **Error Handling**: Tratamento abrangente de PIDs inv√°lidos (ESRCH) e permiss√µes (EPERM)
- **Logging**: Logs estruturados com contexto adequado, sem vazamento de dados sens√≠veis
- **Performance**: Polling eficiente de 100ms para verifica√ß√£o de t√©rmino de processos

**Interface Definition (apps/web/app/types/services.ts:112-116)**
- Interface clara e bem definida seguindo padr√µes do projeto
- M√©todos apropriados para gerenciamento do ciclo de vida do servi√ßo

**Service Integration (apps/web/app/lib/service-container.ts:69-72)**
- Integra√ß√£o adequada via service container com inje√ß√£o de depend√™ncias
- Singleton pattern corretamente implementado

**Application Bootstrap (apps/web/app/entry.server.tsx:25-38)**
- Inicializa√ß√£o no startup da aplica√ß√£o implementada corretamente
- Graceful shutdown configurado para SIGINT e SIGTERM
- Logs informativos sobre inicializa√ß√£o e parada do servi√ßo

### ‚úÖ Test Coverage & Quality

**Test Suite (apps/web/app/services/session-timeout.service.test.ts:302)**
- **Coverage**: 11 testes passando, cobrindo cen√°rios principais ‚úÖ
- **Mocking Strategy**: Excelente uso de mocks para process.kill, timers e SessionPersistenceService
- **Edge Cases**: Testes abrangentes para PIDs inv√°lidos, permiss√µes, processos inexistentes
- **Error Scenarios**: Valida√ß√£o de comportamento durante falhas de cleanup peri√≥dico
- **Timer Management**: Verifica√ß√£o adequada de singleton pattern e lifecycle de timers

**Test Execution Results:**
```
‚úì apps/web/app/services/session-timeout.service.test.ts (11 tests) 22ms
Test Files  1 passed (1)
Tests  11 passed (11)
```

### ‚úÖ Architecture Compliance

**Coding Standards Adherence:**
- ‚úÖ TypeScript 5.8 e Node.js 22.x
- ‚úÖ Shared types importados de `packages/shared-types`
- ‚úÖ Business logic em `apps/web/app/services/`
- ‚úÖ Error handling com classes customizadas
- ‚úÖ Naming conventions seguidas (camelCase para services)
- ‚úÖ Interface segregation seguindo padr√µes do projeto

**Error Handling Strategy:**
- ‚úÖ Logs estruturados usando Pino/logger estruturado
- ‚úÖ Sem exposi√ß√£o de dados sens√≠veis em logs
- ‚úÖ Tratamento apropriado de exce√ß√µes com continuidade do servi√ßo

### ‚úÖ Acceptance Criteria Validation

**AC 1 - Tarefa Agendada Peri√≥dica:**
- ‚úÖ `startPeriodicCleanup()` implementado com intervalo de 30 minutos
- ‚úÖ Singleton pattern garante apenas uma inst√¢ncia ativa
- ‚úÖ Timer configur√°vel via par√¢metro opcional

**AC 2 - Identifica√ß√£o de Sess√µes Expiradas:**
- ‚úÖ L√≥gica de timeout de 12 horas implementada corretamente
- ‚úÖ Compara√ß√£o precisa entre `startedAt` e timestamp atual
- ‚úÖ Logs informativos sobre sess√µes identificadas para limpeza

**AC 3 - Encerramento e Remo√ß√£o:**
- ‚úÖ Processo `claude code` encerrado com `process.kill(pid, 'SIGTERM')`
- ‚úÖ Fallback para `SIGKILL` ap√≥s timeout de 5 segundos
- ‚úÖ Remo√ß√£o da entrada via `SessionPersistenceService.removeSession()`
- ‚úÖ Tratamento robusto de processos j√° encerrados ou com PIDs inv√°lidos

### üîß Minor Improvements Applied

Durante a revis√£o, identifiquei que o c√≥digo est√° muito bem implementado e n√£o requer refatora√ß√µes significativas. A implementa√ß√£o segue fielmente as especifica√ß√µes e padr√µes arquiteturais estabelecidos.

### üìã Security & Performance Validation

**Security:**
- ‚úÖ Valida√ß√£o de PIDs antes de terminar processos
- ‚úÖ Uso de SIGTERM para graceful shutdown
- ‚úÖ Logs n√£o exp√µem informa√ß√µes sens√≠veis
- ‚úÖ Tratamento adequado de erros de permiss√£o

**Performance:**
- ‚úÖ Cache do SessionPersistenceService reduz I/O
- ‚úÖ Intervalo de 30 minutos balanceia responsividade vs overhead
- ‚úÖ Timeout de graceful shutdown evita processos zumbis
- ‚úÖ Polling eficiente de 100ms para verifica√ß√£o de processos

### ‚úÖ Final Recommendation

**STORY APROVADA PARA PRODU√á√ÉO**

A implementa√ß√£o do SessionTimeoutService est√° tecnicamente s√≥lida, segue rigorosamente os padr√µes arquiteturais estabelecidos, possui cobertura de testes adequada e atende completamente aos crit√©rios de aceita√ß√£o. O c√≥digo demonstra maturidade t√©cnica e pode ser deployado com confian√ßa.

**Ready for Deployment** ‚úÖ