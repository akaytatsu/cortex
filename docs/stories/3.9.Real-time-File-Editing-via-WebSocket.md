# Story 3.9: Real-time File Editing via WebSocket

## Status

Pending

## Story

**As a** logged-in user,
**I want** to view and edit files using WebSocket connections,
**so that** I can see changes in real-time without page refreshes and have a more responsive editing experience.

## Acceptance Criteria

1. A visualização de arquivos carrega via WebSocket em tempo real.
2. A edição de arquivos envia mudanças via WebSocket instantaneamente.
3. O auto-save está implementado mas desabilitado por padrão (configurável para ativação futura).
4. As mudanças no sistema de arquivos são refletidas automaticamente na interface.
5. A conexão WebSocket se reconecta automaticamente em caso de falhas.

## Tasks / Subtasks

- [ ] Task 1 (AC: 1): Implementar WebSocket para carregamento de arquivos em tempo real
  - [ ] Criar WebSocket server em Node.js para file operations
  - [ ] Implementar cliente WebSocket no frontend para receber file content
  - [ ] Migrar CodeViewer de HTTP fetch para WebSocket communication
  - [ ] Implementar loading states e error handling para WebSocket connections
  - [ ] Adicionar debounce e throttling para otimizar performance
- [ ] Task 2 (AC: 2): Implementar edição em tempo real via WebSocket
  - [ ] Enviar mudanças de texto via WebSocket em real-time (com debounce)
  - [ ] Implementar operational transforms ou conflict resolution básico
  - [ ] Migrar save functionality de HTTP POST para WebSocket messages
  - [ ] Implementar queue de mudanças para garantir ordem e integridade
  - [ ] Adicionar feedback visual para mudanças sendo enviadas/confirmadas
- [ ] Task 3 (AC: 3): Implementar auto-save (desabilitado por padrão)
  - [ ] Implementar infraestrutura de auto-save timer baseado em mudanças
  - [ ] Criar configuração para enable/disable auto-save (default: disabled)
  - [ ] Implementar save states (saving, saved, error) via WebSocket
  - [ ] Manter Ctrl+S manual como método principal de save
  - [ ] Implementar conflict detection quando arquivo mudou externamente
  - [ ] Adicionar visual indicator para auto-save status quando habilitado
- [ ] Task 4 (AC: 4): File system watchers para mudanças externas
  - [ ] Implementar file watchers no backend usando fs.watch ou chokidar
  - [ ] Notificar clientes via WebSocket quando arquivos mudam externamente
  - [ ] Implementar merge strategies para mudanças concorrentes
  - [ ] Atualizar FileBrowser tree quando arquivos/pastas são criados/deletados
  - [ ] Implementar notifications para usuário sobre mudanças externas
- [ ] Task 5 (AC: 5): Connection resilience e reconnection
  - [ ] Implementar automatic reconnection com exponential backoff
  - [ ] Manter queue de mudanças pendentes durante disconnection
  - [ ] Implementar sync mechanism após reconnection
  - [ ] Adicionar connection status indicator na UI
  - [ ] Implementar fallback para HTTP em caso de WebSocket failure persistente
- [ ] Task 6: Testing
  - [ ] Unit tests para WebSocket server file operations
  - [ ] Integration tests para real-time editing workflows
  - [ ] Tests de reconexão e network failure scenarios
  - [ ] Performance tests para multiple concurrent connections
  - [ ] Security tests para WebSocket authentication e authorization

## Dev Notes

### Previous Story Context

- **Story 3.4 (Done)**: Implementou FileBrowser e CodeViewer read-only via HTTP requests [Source: docs/stories/3.4.md]
- **Story 3.5 (Done)**: Adicionou edição e save via HTTP POST requests [Source: docs/stories/3.5.md]
- **Current State**: Sistema funcional mas com refreshes manuais e latência de HTTP requests

### Technical Approach - WebSocket Integration

#### Architecture Overview
```
Frontend (React/Remix) ←→ WebSocket Server ←→ FileSystem
     ↓                          ↓                    ↓
 Real-time UI              Message Broker      File Watchers
```

#### WebSocket Message Protocol
```typescript
// Message Types
interface WSMessage {
  type: 'file_content' | 'file_change' | 'save_request' | 'save_confirmation' |
        'file_created' | 'file_deleted' | 'error' | 'connection_status';
  payload: any;
  messageId?: string; // for request/response correlation
}

// Specific Message Formats
interface FileContentMessage {
  type: 'file_content';
  payload: {
    path: string;
    content: string;
    lastModified: Date;
    mimeType: string;
  };
}

interface FileChangeMessage {
  type: 'file_change';
  payload: {
    path: string;
    changes: TextDelta[]; // operational transforms
    timestamp: Date;
  };
}

interface SaveRequestMessage {
  type: 'save_request';
  payload: {
    path: string;
    content: string;
    lastKnownModified: Date;
  };
  messageId: string;
}
```

### Data Models

- **Existing Models**: Manter compatibilidade com `FileSystemItem` e `FileContent` de stories anteriores
- **New WebSocket Models**:
  ```typescript
  interface WSConnection {
    id: string;
    userId: string;
    workspaceName: string;
    connectedAt: Date;
    lastActivity: Date;
  }

  interface FileSession {
    filePath: string;
    connections: WSConnection[];
    lastModified: Date;
    pendingChanges: TextDelta[];
  }

  interface TextDelta {
    operation: 'insert' | 'delete' | 'retain';
    position: number;
    text?: string;
    length?: number;
    timestamp: Date;
    connectionId: string;
  }
  ```

### Technical Stack Additions

- **WebSocket Server**: `ws` ou `socket.io` para Node.js WebSocket implementation
- **File Watching**: `chokidar` para robust file system watching cross-platform
- **Text Operations**: Implementar operational transforms básico ou usar `yjs` para collaborative editing
- **Connection Management**: Redis para multi-instance WebSocket state sharing (futuro)
- **Queue System**: In-memory queue com persistence opcional para message reliability

### API/Service Changes

#### New Services
- **`WebSocketService`**: Manage WebSocket connections e message routing
- **`FileWatcherService`**: Monitor file system changes e notify clients
- **`CollaborationService`**: Handle concurrent editing e conflict resolution
- **`MessageQueueService`**: Queue messages during disconnections

#### Modified Services
- **`FileSystemService`**: Extend com WebSocket notifications para file operations
- **`WorkspaceService`**: Add WebSocket authentication e workspace isolation

### Component Changes

#### Modified Components
- **`CodeViewer.tsx`**: Migrar de HTTP fetcher para WebSocket client
  - Real-time content updates via WebSocket messages
  - Manter manual save button (Ctrl+S) como método principal
  - Add connection status indicators
  - Implement auto-save visual feedback (quando habilitado)
  - Adicionar toggle de configuração para auto-save (default: disabled)
- **`FileBrowser.tsx`**: Subscribe to file system change notifications
  - Auto-refresh tree quando files/folders change
  - Visual indicators para files being edited por outros users
- **`IDELayout.tsx`**: Add WebSocket connection management
  - Connection status indicator
  - Reconnection handling
  - Fallback mechanisms

#### New Components
- **`WebSocketProvider.tsx`**: React context para WebSocket connection sharing
- **`ConnectionStatus.tsx`**: Visual indicator para connection health
- **`CollaborationIndicator.tsx`**: Show quando outros users estão editing (futuro)

### Security Considerations

- **Authentication**: WebSocket connections devem validate user sessions
- **Authorization**: Verificar workspace access permissions per connection
- **Message Validation**: Validate all incoming WebSocket messages
- **Rate Limiting**: Prevent WebSocket message flooding
- **Path Validation**: Manter existing path validation para prevent directory traversal
- **Encryption**: Use WSS (WebSocket Secure) em production

### Performance Optimizations

- **Debouncing**: Group rapid text changes antes de send via WebSocket
- **Delta Compression**: Send apenas changes, não full file content
- **Connection Pooling**: Efficient WebSocket connection management
- **Message Batching**: Group multiple pequenas mudanças em single message
- **Memory Management**: Cleanup old file sessions e connection state

### Implementation Phases

#### Phase 1: Basic WebSocket Foundation
- Setup WebSocket server
- Implement basic file content loading via WebSocket
- Migrate CodeViewer para WebSocket communication

#### Phase 2: Real-time Editing
- Implement text change detection e transmission
- Add auto-save infrastructure (disabled by default)
- Basic conflict detection
- Configuração toggle para auto-save

#### Phase 3: File System Watching
- Add file watchers para external changes
- Update FileBrowser tree em real-time
- Implement merge strategies

#### Phase 4: Connection Resilience
- Automatic reconnection
- Offline queue management
- Fallback mechanisms

### Testing Strategy

- **Unit Tests**: WebSocket message handlers, file watchers, operational transforms
- **Integration Tests**: End-to-end real-time editing workflows
- **Performance Tests**: Multiple concurrent connections, large file handling
- **Network Tests**: Disconnection/reconnection scenarios, message reliability
- **Security Tests**: Authentication bypass attempts, message injection

### Migration Strategy

1. **Backward Compatibility**: Manter HTTP endpoints como fallback durante transição
2. **Feature Flags**: Allow users escolher entre HTTP e WebSocket modes
3. **Gradual Rollout**: Enable WebSocket para subset of users initially
4. **Monitoring**: Comprehensive logging para track adoption e issues

### Error Handling

- **Connection Failures**: Graceful degradation para HTTP mode
- **Message Corruption**: Validate e reject invalid messages
- **File Conflicts**: User notification e resolution options
- **Server Overload**: Queue management e backpressure handling

## Change Log

| Date       | Version | Description   | Author             |
| ---------- | ------- | ------------- | ------------------ |
| 2025-07-22 | 1.0     | Initial draft | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results

### Review Date
(To be filled by QA)

### Reviewed By
(To be filled by QA)

### Final Status
(To be filled by QA)