# Story 4.2: Backend - Gerenciamento do Ciclo de Vida de Processos `claude code`

**Status**: Done

## Story
**As a** Desenvolvedor(a),
**I want** que o backend possa iniciar, gerenciar e encerrar processos da CLI `claude code`, inclusive com comandos de inicialização,
**so that** as sessões possam ser controladas dinamicamente.

## Acceptance Criteria
1. O backend pode iniciar um novo processo `claude code` no diretório de um workspace.
2. A função de inicialização aceita um parâmetro opcional de comando (ex: para executar `claude "/meu-agente"`).
3. O backend pode associar o `PID` do processo a um ID de sessão único e encerrar a sessão pelo seu ID.
4. A saída (`stdout`) e erros (`stderr`) do processo são capturados para serem retransmitidos via WebSocket.

## Tasks / Subtasks
- [x] **Task 1: Implementar o `CliService` para Gerenciamento de Processos** (AC: 1, 2, 3)
    - [x] Subtask 1.1: Criar o arquivo `apps/web/app/services/cli.service.ts`. [Source: docs/architecture/source-tree.md]
    - [x] Subtask 1.2: Implementar uma função `startProcess` que utiliza o `spawn` do `child_process` para iniciar um processo `claude code`. [Source: docs/architecture/high-level-architecture.md]
    - [x] Subtask 1.3: A função `startProcess` deve aceitar o caminho do workspace e um comando opcional.
    - [x] Subtask 1.4: Implementar validação e sanitização robusta do parâmetro de comando:
        - Criar whitelist de comandos permitidos (apenas `claude` e seus parâmetros válidos)
        - Validar formato do comando usando regex para detectar caracteres perigosos (`;`, `&`, `|`, `$`, backticks)
        - Sanitizar argumentos removendo ou escapando caracteres especiais do shell
        - Implementar timeout para execução de comandos (máximo 30 segundos para inicialização)
        - Logar tentativas de comandos suspeitos para auditoria de segurança
    - [x] Subtask 1.5: Implementar uma função `stopProcess` que encerra um processo com base no seu `PID`.
- [x] **Task 2: Integração com o Servidor WebSocket** (AC: 4)
    - [x] Subtask 2.1: Modificar o `apps/web/app/lib/websocket-server.ts` para utilizar o `CliService`. [Source: docs/architecture/source-tree.md]
    - [x] Subtask 2.2: Implementar protocolo de mapeamento sessionId-PID:
        - Ao receber mensagem `start_session` com `{workspacePath, command?, sessionId}`, chamar `CliService.startProcess`
        - Armazenar mapeamento `sessionId -> {PID, websocketConnection, startTime}` em Map interno
        - Retornar mensagem `session_started` com `{sessionId, status: 'success'|'error', message?}`
    - [x] Subtask 2.3: Implementar redirecionamento de output:
        - Capturar stdout/stderr do processo e encapsular em mensagens `{type: 'stdout'|'stderr', data: string, sessionId}`
        - Enviar apenas para o WebSocket client associado ao sessionId específico
        - Implementar buffering para evitar spam de mensagens muito pequenas
    - [x] Subtask 2.4: Implementar encerramento controlado:
        - Ao receber mensagem `stop_session` com `{sessionId}`, chamar `CliService.stopProcess(PID)`
        - Remover mapeamento sessionId do Map interno
        - Enviar confirmação `session_stopped` com `{sessionId, exitCode?}`
- [x] **Task 3: Testes**
    - [x] Subtask 3.1: Escrever testes de unidade para o `CliService`, mockando o `child_process`. [Source: docs/architecture/test-strategy.md]
    - [x] Subtask 3.2: Escrever testes de integração para o fluxo de iniciar e parar um processo através do WebSocket. [Source: docs/architecture/test-strategy.md]

## Dev Notes
### Requisitos Técnicos
- **Tecnologia:** Node.js `child_process` [Source: docs/architecture/high-level-architecture.md]
- **Localização do Código:** `apps/web/app/services/cli.service.ts` [Source: docs/architecture/source-tree.md]
- **Padrões de Código:** Seguir os padrões definidos em `docs/architecture/coding-standards.md`.

### Gerenciamento de Processos
O `CliService` será responsável por toda a interação com processos filhos. Ele deve ser um singleton para evitar múltiplos gerenciadores de processos.

### Integração com WebSocket
O `websocket-server` irá orquestrar a comunicação entre o cliente e o `CliService`. Ele irá manter o mapeamento entre `sessionId` e `PID` do processo através de uma estrutura interna:

```typescript
interface SessionMapping {
  pid: number;
  websocketConnection: WebSocket;
  startTime: Date;
  workspacePath: string;
}

// Map<sessionId, SessionMapping>
const activeSessions = new Map<string, SessionMapping>();
```

**Protocolo de Mensagens WebSocket:**
- `start_session`: `{type: 'start_session', sessionId: string, workspacePath: string, command?: string}`
- `session_started`: `{type: 'session_started', sessionId: string, status: 'success'|'error', message?: string}`
- `stop_session`: `{type: 'stop_session', sessionId: string}`
- `session_stopped`: `{type: 'session_stopped', sessionId: string, exitCode?: number}`
- `stdout`: `{type: 'stdout', sessionId: string, data: string}`
- `stderr`: `{type: 'stderr', sessionId: string, data: string}`

### Testing
- **Localização dos Testes:** Os testes para `apps/web/app/services/cli.service.ts` devem ser criados em `apps/web/app/services/cli.service.test.ts`. [Source: docs/architecture/test-strategy.md]
- **Frameworks e Padrões:** Utilizar Vitest para testes de unidade e integração conforme definido na estratégia de testes. [Source: docs/architecture/test-strategy.md]
- **Estratégia de Testes:**
    - **Testes de Unidade:** Utilizar mocks para o módulo `child_process` nos testes de unidade para simular a criação e o encerramento de processos.
    - **Testes de Integração:** Verificar se a comunicação via WebSocket resulta na chamada correta das funções do `CliService`.
    - **Cobertura:** Atingir >80% de cobertura nas funções críticas do `CliService` conforme filosofia de testes. [Source: docs/architecture/test-strategy.md]
- **Requisitos Específicos desta História:**
    - Testar sanitização de comandos para prevenir command injection
    - Testar gerenciamento correto de PIDs e associação com sessionIds
    - Testar captura adequada de stdout/stderr dos processos filhos

## Change Log
| Data | Versão | Descrição | Autor |
|---|---|---|---|
| 2025-07-23 | 1.0 | Criação inicial da história | Bob (sm) |
| 2025-07-23 | 1.1 | Corrigida estrutura e adicionada validação de segurança | Sarah (po) |
| 2025-07-23 | 1.2 | Adicionada seção Testing, removidos placeholders _TBD_, expandidas especificações de segurança e protocolo WebSocket | Sarah (po) |

## Dev Agent Record
### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- All tests passing: 22/22 tests for CliService
- All tests passing: 14/14 tests for WebSocket integration

### Completion Notes List
- Implementado CliService completo com validação robusta de comandos e sanitização
- Integração completa com WebSocket server para gerenciamento de sessões Claude Code
- Protocolo de mensagens implementado conforme especificação na story
- Redirecionamento de output com buffering implementado para evitar spam
- Todos os testes unitários e de integração implementados e passando
- Validações de segurança implementadas: whitelist de comandos, detecção de caracteres perigosos, timeout de execução
- Gerenciamento correto de PIDs e mapeamento sessionId-PID
- Tratamento adequado de exit de processos com cleanup automático

### File List
- apps/web/app/services/cli.service.ts (novo arquivo) - Serviço principal para gerenciamento de processos Claude Code
- apps/web/app/services/cli.service.test.ts (novo arquivo) - Testes unitários do CliService
- apps/web/app/lib/websocket-server-integration.test.ts (novo arquivo) - Testes de integração WebSocket
- apps/web/app/lib/websocket-server.ts (modificado) - Integração com CliService e protocolo de mensagens
- packages/shared-types/index.ts (modificado) - Novas interfaces ClaudeCodeMessage e SessionMapping


## QA Results

### Review Date: 2025-07-23
### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
A implementação está **excelente** com arquitetura sólida e práticas de segurança robustas. O código segue padrões profissionais com tratamento adequado de erros, logging estruturado, e validações de segurança abrangentes. A separação de responsabilidades entre CliService e WebSocket server está bem definida.

### Refactoring Performed
- **File**: apps/web/app/services/cli.service.ts
  - **Change**: Melhorada a regex de caracteres perigosos para incluir `<>` (`/[;&|$`\\<>]/`)
  - **Why**: Adiciona proteção contra redirecionamento de I/O que poderia ser usado maliciosamente
  - **How**: Expande a detecção de caracteres perigosos para cobrir mais vetores de ataque

- **File**: apps/web/app/services/cli.service.ts
  - **Change**: Implementado gerenciamento adequado de timeouts no processo de parada
  - **Why**: Previne vazamentos de memória e recursos quando processos não terminam graciosamente
  - **How**: Armazena referência ao timeout na interface ClaudeProcess e limpa adequadamente nos event handlers

- **File**: apps/web/app/services/cli.service.ts
  - **Change**: Melhorado método cleanup() para limpar timeouts antes de parar processos
  - **Why**: Evita vazamentos de memória e comportamentos não determinísticos no shutdown
  - **How**: Itera sobre processos ativos limpando timeouts antes de chamar stopProcess

### Compliance Check
- Coding Standards: ✓ **Excelente** - Código segue padrões TypeScript profissionais, nomes descritivos, estrutura clara
- Project Structure: ✓ **Perfeito** - Arquivos organizados conforme arquitetura definida (`services/`, interfaces em `shared-types/`)
- Testing Strategy: ✓ **Abrangente** - 22/22 testes unitários + 14/14 testes integração, >90% cobertura, mocks adequados
- All ACs Met: ✓ **Completo** - Todos os 4 Acceptance Criteria implementados e testados

### Improvements Checklist
- [x] Refatorado CliService para melhor gerenciamento de recursos e segurança
- [x] Melhorada validação de comandos com regex mais robusta
- [x] Implementado cleanup adequado de timeouts para prevenir vazamentos
- [x] Verificado que todos os testes passam (36/36 testes successful)
- [x] Validado protocolo WebSocket conforme especificação da história
- [x] Confirmado que sanitização de comandos funciona corretamente

### Security Review
**✓ Excelente implementação de segurança:**
- Whitelist rigorosa de comandos (apenas `claude` permitido)
- Regex robusta detecta caracteres perigosos (`[;&|$`\\<>]`)
- Validação de path workspace previne directory traversal
- Timeout de execução (30s) previne processos infinitos
- Sanitização de argumentos remove caracteres especiais
- Logging de tentativas suspeitas para auditoria
- Tratamento seguro de processos filhos com cleanup adequado

### Performance Considerations
**✓ Implementação otimizada:**
- Buffering de output (50ms) previne spam de mensagens WebSocket
- Gerenciamento eficiente de Map para processos ativos
- Cleanup adequado de recursos (timeouts, event listeners)
- Singleton pattern no WebSocket server previne múltiplas instâncias
- Tratamento assíncrono adequado sem blocking operations

### Final Status
**✓ Approved - Ready for Done**

A implementação está **completa e de alta qualidade**. Todos os Acceptance Criteria foram atendidos, a cobertura de testes é excelente (36/36 passing), e as práticas de segurança são rigorosas. O código segue padrões profissionais e está pronto para produção.
