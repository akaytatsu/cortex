# Story 4.2: Backend - Gerenciamento do Ciclo de Vida de Processos `claude code`

**Status**: Draft

## Story
**As a** Desenvolvedor(a),
**I want** que o backend possa iniciar, gerenciar e encerrar processos da CLI `claude code`, inclusive com comandos de inicialização,
**so that** as sessões possam ser controladas dinamicamente.

## Acceptance Criteria
1. O backend pode iniciar um novo processo `claude code` no diretório de um workspace.
2. A função de inicialização aceita um parâmetro opcional de comando (ex: para executar `claude "/meu-agente"`).
3. O backend pode associar o `PID` do processo a um ID de sessão único e encerrar a sessão pelo seu ID.
4. A saída (`stdout`) e erros (`stderr`) do processo são capturados para serem retransmitidos via WebSocket.

## Tasks / Subtasks
- [ ] **Task 1: Implementar o `CliService` para Gerenciamento de Processos** (AC: 1, 2, 3)
    - [ ] Subtask 1.1: Criar o arquivo `apps/web/app/services/cli.service.ts`. [Source: docs/architecture/source-tree.md]
    - [ ] Subtask 1.2: Implementar uma função `startProcess` que utiliza o `spawn` do `child_process` para iniciar um processo `claude code`. [Source: docs/architecture/high-level-architecture.md]
    - [ ] Subtask 1.3: A função `startProcess` deve aceitar o caminho do workspace e um comando opcional.
    - [ ] Subtask 1.4: Adicionar validação e sanitização ao parâmetro de comando para prevenir injeção de código.
    - [ ] Subtask 1.5: Implementar uma função `stopProcess` que encerra um processo com base no seu `PID`.
- [ ] **Task 2: Integração com o Servidor WebSocket** (AC: 4)
    - [ ] Subtask 2.1: Modificar o `apps/web/app/lib/websocket-server.ts` para utilizar o `CliService`. [Source: docs/architecture/source-tree.md]
    - [ ] Subtask 2.2: Ao receber uma mensagem para iniciar uma sessão, chamar o `CliService.startProcess`.
    - [ ] Subtask 2.3: Redirecionar o `stdout` e `stderr` do processo para o cliente WebSocket correspondente.
    - [ ] Subtask 2.4: Ao receber uma mensagem para encerrar uma sessão, chamar o `CliService.stopProcess`.
- [ ] **Task 3: Testes**
    - [ ] Subtask 3.1: Escrever testes de unidade para o `CliService`, mockando o `child_process`. [Source: docs/architecture/test-strategy.md]
    - [ ] Subtask 3.2: Escrever testes de integração para o fluxo de iniciar e parar um processo através do WebSocket. [Source: docs/architecture/test-strategy.md]

## Dev Notes
### Requisitos Técnicos
- **Tecnologia:** Node.js `child_process` [Source: docs/architecture/high-level-architecture.md]
- **Localização do Código:** `apps/web/app/services/cli.service.ts` [Source: docs/architecture/source-tree.md]
- **Padrões de Código:** Seguir os padrões definidos em `docs/architecture/coding-standards.md`.

### Gerenciamento de Processos
O `CliService` será responsável por toda a interação com processos filhos. Ele deve ser um singleton para evitar múltiplos gerenciadores de processos.

### Integração com WebSocket
O `websocket-server` irá orquestrar a comunicação entre o cliente e o `CliService`. Ele irá manter o mapeamento entre `sessionId` e `PID` do processo.

### Testes
- **Localização dos Testes:** Os testes para `apps/web/app/services/cli.service.ts` devem ser criados em `apps/web/app/services/cli.service.test.ts`. [Source: docs/architecture/test-strategy.md]
- **Estratégia de Testes:**
    - Utilizar mocks para o módulo `child_process` nos testes de unidade para simular a criação e o encerramento de processos.
    - Nos testes de integração, verificar se a comunicação via WebSocket resulta na chamada correta das funções do `CliService`.

## Change Log
| Data | Versão | Descrição | Autor |
|---|---|---|---|
| 2025-07-23 | 1.0 | Criação inicial da história | Bob (sm) |
| 2025-07-23 | 1.1 | Corrigida estrutura e adicionada validação de segurança | Sarah (po) |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results
_TBD_